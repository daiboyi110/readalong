<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ReadAlong â€” Reading Accuracy Trainer</title>
  <style>
    :root {
      --primary:       #5b21b6;
      --primary-lt:    #7c3aed;
      --primary-pale:  #ede9fe;
      --success:       #059669;
      --success-bg:    #d1fae5;
      --danger:        #dc2626;
      --danger-bg:     #fee2e2;
      --bg:            #f5f3ff;
      --card:          #ffffff;
      --text:          #1e1b4b;
      --muted:         #6b7280;
      --border:        #ddd6fe;
    }

    *          { margin:0; padding:0; box-sizing:border-box; }
    body       { font-family:'Segoe UI',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: linear-gradient(135deg,#4c1d95,#3730a3);
      color:#fff;
      padding:0 24px;
      position:sticky; top:0; z-index:50;
      box-shadow:0 4px 20px rgba(76,29,149,.4);
    }
    .header-top {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 0 10px;
    }
    .logo       { font-size:1.45rem; font-weight:800; letter-spacing:-.5px; }
    .logo em    { color:#c4b5fd; font-style:normal; }
    .tagline    { font-size:.8rem; opacity:.75; }
    .theme-tabs { display:flex; gap:2px; overflow-x:auto; padding-bottom:0; }
    .theme-tab  {
      padding:10px 15px; border:none; background:transparent;
      color:rgba(255,255,255,.6); cursor:pointer; font-size:.88rem; font-weight:500;
      border-bottom:3px solid transparent; white-space:nowrap; transition:all .2s;
    }
    .theme-tab:hover  { color:#fff; }
    .theme-tab.active { color:#fff; border-bottom-color:#c4b5fd; }

    /* â”€â”€ Browser notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #browserNotice {
      display:none; background:#fef9c3; border-bottom:2px solid #facc15;
      color:#713f12; padding:10px 24px; font-size:.85rem; text-align:center;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container { max-width:880px; margin:0 auto; padding:24px 16px 52px; display:flex; flex-direction:column; gap:20px; }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px 26px; box-shadow:0 2px 14px rgba(91,33,182,.07); }
    .card-label { font-size:.7rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:14px; }

    /* â”€â”€ Passage grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .passage-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:11px; }
    .pcard {
      border:2px solid var(--border); border-radius:12px; padding:14px 16px;
      cursor:pointer; transition:all .2s; background:#fafafa;
    }
    .pcard:hover        { border-color:var(--primary-lt); background:var(--primary-pale); }
    .pcard.active       { border-color:var(--primary-lt); background:var(--primary-pale); box-shadow:0 0 0 3px rgba(124,58,237,.14); }
    .pcard-title        { font-weight:600; font-size:.9rem; margin-bottom:6px; }
    .badge              { display:inline-block; padding:1px 8px; border-radius:20px; font-size:.67rem; font-weight:700; }
    .easy               { background:#d1fae5; color:#065f46; }
    .medium             { background:#fef3c7; color:#78350f; }
    .hard               { background:#fee2e2; color:#7f1d1d; }

    /* â”€â”€ Passage text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .passage-title { font-size:1rem; font-weight:700; color:var(--primary); margin-bottom:14px; }
    #passageText   { font-family:Georgia,serif; font-size:1.22rem; line-height:2.15; }
    .w             { display:inline; padding:1px 2px; border-radius:3px; transition:all .25s; }
    .w.correct     { background:var(--success-bg); color:#065f46; }
    .w.incorrect   { background:var(--danger-bg); color:#7f1d1d; text-decoration:line-through; }

    /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls      { display:flex; flex-direction:column; align-items:center; gap:14px; }
    #recordBtn {
      width:82px; height:82px; border-radius:50%; border:none; cursor:pointer;
      font-size:1.9rem; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,var(--primary-lt),var(--primary));
      color:#fff; box-shadow:0 6px 24px rgba(91,33,182,.35); transition:transform .25s;
    }
    #recordBtn:hover:not(:disabled) { transform:scale(1.06); }
    #recordBtn:disabled { opacity:.5; cursor:not-allowed; }
    #recordBtn.recording {
      background:linear-gradient(135deg,#f87171,var(--danger));
      box-shadow:0 6px 24px rgba(220,38,38,.4);
      animation:ripple 1.5s infinite;
    }
    #recordBtn.pausing {
      background:linear-gradient(135deg,#9ca3af,#6b7280);
      box-shadow:0 4px 14px rgba(0,0,0,.2);
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    @keyframes ripple {
      0%   { box-shadow:0 0 0 0   rgba(220,38,38,.45); }
      70%  { box-shadow:0 0 0 18px rgba(220,38,38,0);  }
      100% { box-shadow:0 0 0 0   rgba(220,38,38,0);   }
    }
    #statusText      { font-size:.9rem; font-weight:500; color:var(--muted); text-align:center; }
    #statusText.live { color:var(--danger); }
    .ghost-btn {
      padding:7px 18px; border-radius:8px; border:2px solid var(--border);
      background:transparent; cursor:pointer; font-size:.84rem; color:var(--muted); transition:all .2s;
    }
    .ghost-btn:hover { border-color:var(--primary-lt); color:var(--primary); }

    /* â”€â”€ Transcript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #transcriptText { font-size:1rem; line-height:1.85; min-height:64px; }
    .interim        { color:var(--muted); font-style:italic; }
    .placeholder    { color:#9ca3af; font-style:italic; }

    /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #resultsCard         { display:none; }
    #resultsCard.visible { display:block; }

    .results-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .results-title  { font-size:1.1rem; font-weight:800; }

    .grade-badge  { font-size:1.4rem; font-weight:800; padding:4px 14px; border-radius:10px; }
    .grade-Ap,.grade-A { background:#d1fae5; color:#065f46; }
    .grade-B               { background:#dbeafe; color:#1e40af; }
    .grade-C               { background:#fef3c7; color:#92400e; }
    .grade-D               { background:#ffedd5; color:#9a3412; }
    .grade-F               { background:#fee2e2; color:#991b1b; }

    /* replay */
    .replay-row {
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      background:var(--primary-pale); border-radius:12px; padding:12px 16px; margin-bottom:18px;
    }
    .replay-label { font-size:.82rem; font-weight:700; color:var(--primary); white-space:nowrap; }
    #replayAudio  { flex:1; min-width:180px; height:34px; }

    /* scores */
    .score-row  { display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .score-box  { flex:1; min-width:80px; text-align:center; padding:14px 8px; background:var(--primary-pale); border-radius:12px; }
    .score-value { font-size:1.75rem; font-weight:800; color:var(--primary); }
    .score-label { font-size:.67rem; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); margin-top:3px; }

    .bar-wrap    { background:#e5e7eb; border-radius:50px; height:12px; overflow:hidden; margin-bottom:20px; }
    #accuracyBar { height:100%; border-radius:50px; background:linear-gradient(90deg,#10b981,#059669); width:0%; transition:width 1s ease, background 1s; }

    /* word analysis */
    .analysis-wrap h4 { font-size:.7rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:10px; }
    .legend      { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px; }
    .legend-item { display:flex; align-items:center; gap:6px; font-size:.78rem; color:var(--muted); }
    .legend-dot  { width:12px; height:12px; border-radius:3px; }
    .wr-wrap     { line-height:2.6; }

    .wr {
      display:inline-flex; align-items:center; gap:3px;
      padding:3px 9px; margin:3px 2px; border-radius:6px;
      font-family:Georgia,serif; font-size:.9rem;
    }
    .wr.match { background:var(--success-bg); color:#065f46; }
    .wr.miss  { background:var(--danger-bg);  color:#7f1d1d; text-decoration:line-through; }
    .wr-icon {
      display:inline-flex; align-items:center; justify-content:center;
      width:20px; height:20px; border-radius:4px; border:none;
      cursor:pointer; font-size:.72rem; padding:0;
      background:rgba(220,38,38,.13); color:#991b1b; transition:background .15s;
    }
    .wr-icon:hover { background:rgba(220,38,38,.27); }

    .tip-box { margin-top:16px; padding:12px 16px; background:#f0fdf4; border-left:4px solid #10b981; border-radius:0 8px 8px 0; font-size:.85rem; color:#065f46; }

    /* â”€â”€ Practice modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #practiceModal {
      display:none; position:fixed; inset:0; z-index:200;
      background:rgba(15,10,40,.65); backdrop-filter:blur(5px);
      align-items:center; justify-content:center; padding:16px;
    }
    #practiceModal.open { display:flex; }
    .modal-card { background:#fff; border-radius:20px; padding:28px; width:100%; max-width:420px; box-shadow:0 24px 64px rgba(0,0,0,.28); }
    .modal-hdr  { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
    .modal-subtitle { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--muted); }
    .modal-word { font-family:Georgia,serif; font-size:2.1rem; font-weight:700; color:var(--primary); margin:4px 0 22px; }
    .modal-close { background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--muted); line-height:1; }
    .modal-close:hover { color:var(--text); }
    .modal-section { margin-bottom:20px; }
    .modal-sec-label { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .btn-row2       { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .btn-primary {
      padding:9px 18px; border-radius:10px; border:none; cursor:pointer;
      font-size:.88rem; font-weight:600; color:#fff;
      background:linear-gradient(135deg,var(--primary-lt),var(--primary));
      display:inline-flex; align-items:center; gap:5px; transition:opacity .2s;
    }
    .btn-primary:hover { opacity:.87; }
    .btn-danger  {
      padding:9px 18px; border-radius:10px; border:none; cursor:pointer;
      font-size:.88rem; font-weight:600; color:#fff;
      background:linear-gradient(135deg,#f87171,var(--danger));
      display:inline-flex; align-items:center; gap:5px; transition:opacity .2s;
    }
    .btn-danger:hover  { opacity:.87; }
    .btn-speed {
      padding:5px 12px; border-radius:6px; border:1.5px solid var(--border);
      background:transparent; cursor:pointer; font-size:.8rem; color:var(--muted); transition:all .2s;
    }
    .btn-speed:hover { border-color:var(--primary-lt); color:var(--primary); }

    #practicePlayer { display:none; margin-top:12px; width:100%; height:34px; }

    .rec-indicator       { display:none; align-items:center; gap:6px; font-size:.8rem; color:var(--danger); font-weight:600; }
    .rec-indicator.show  { display:flex; }
    .rec-dot             { width:8px; height:8px; border-radius:50%; background:var(--danger); animation:blink 1s infinite; }
    .timer-txt           { font-size:.8rem; color:var(--danger); font-weight:600; min-width:30px; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer { text-align:center; padding:0 0 24px; color:var(--muted); font-size:.77rem; }

    @media(max-width:520px){
      #passageText  { font-size:1.08rem; }
      .score-value  { font-size:1.4rem; }
      .passage-grid { grid-template-columns:1fr; }
      .modal-word   { font-size:1.6rem; }
    }
  </style>
</head>
<body>

<div id="browserNotice"></div>

<header>
  <div class="header-top">
    <div class="logo">Read<em>Along</em></div>
    <div class="tagline">Reading Accuracy Trainer</div>
  </div>
  <div class="theme-tabs" id="themeTabs"></div>
</header>

<div class="container">

  <!-- Passage picker -->
  <div class="card">
    <div class="card-label" id="passageGridLabel">Choose a Passage</div>
    <div class="passage-grid" id="passageGrid"></div>
  </div>

  <!-- Reading passage -->
  <div class="card">
    <div class="card-label">Reading Passage</div>
    <div class="passage-title" id="passageTitle"></div>
    <div id="passageText"></div>
  </div>

  <!-- Controls -->
  <div class="card controls">
    <button id="recordBtn" title="Start / Stop recording">ğŸ¤</button>
    <div id="statusText">Click the microphone to start reading aloud</div>
    <button class="ghost-btn" id="resetBtn">â†º Reset</button>
  </div>

  <!-- Transcript -->
  <div class="card">
    <div class="card-label">Live Transcript</div>
    <div id="transcriptText"><span class="placeholder">Your spoken words will appear here in real timeâ€¦</span></div>
  </div>

  <!-- Results -->
  <div class="card" id="resultsCard">
    <div class="results-header">
      <div class="results-title">ğŸ“Š Reading Results</div>
      <div class="grade-badge" id="gradeBadge"></div>
    </div>

    <!-- Replay -->
    <div class="replay-row" id="replayRow" style="display:none">
      <div class="replay-label">ğŸ§ Replay Your Reading</div>
      <audio id="replayAudio" controls></audio>
    </div>

    <!-- Scores -->
    <div class="score-row">
      <div class="score-box"><div class="score-value" id="scoreAccuracy">â€”</div><div class="score-label">Accuracy</div></div>
      <div class="score-box"><div class="score-value" id="scoreWords">â€”</div><div class="score-label">Words Correct</div></div>
      <div class="score-box"><div class="score-value" id="scoreWPM">â€”</div><div class="score-label">Words / Min</div></div>
    </div>

    <div class="bar-wrap"><div id="accuracyBar"></div></div>

    <div class="analysis-wrap">
      <h4>Word-by-Word Analysis</h4>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-dot" style="background:var(--success-bg);border:1px solid #6ee7b7;"></div>
          Correctly read
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background:var(--danger-bg);border:1px solid #fca5a5;"></div>
          Missed â€” <strong>ğŸ”Š</strong> hear correct &nbsp;|&nbsp; <strong>ğŸ¤</strong> practice it
        </div>
      </div>
      <div class="wr-wrap" id="wordAnalysis"></div>
    </div>

    <div class="tip-box" id="tipBox"></div>
  </div>

</div><!-- .container -->

<footer>ReadAlong uses your browser's built-in speech recognition. Audio is processed locally and never sent to any server.</footer>

<!-- â”€â”€ Word Practice Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="practiceModal">
  <div class="modal-card">
    <div class="modal-hdr">
      <div>
        <div class="modal-subtitle">Word Practice</div>
        <div class="modal-word" id="practiceWordDisplay"></div>
      </div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>

    <!-- Correct pronunciation -->
    <div class="modal-section">
      <div class="modal-sec-label">ğŸ”Š Correct Pronunciation</div>
      <div class="btn-row2">
        <button class="btn-primary" onclick="speakPracticeWord(1)">ğŸ”Š Hear it</button>
        <button class="btn-speed"   onclick="speakPracticeWord(0.6)">ğŸ¢ Slowly</button>
      </div>
    </div>

    <!-- User attempt -->
    <div class="modal-section">
      <div class="modal-sec-label">
        ğŸ¤ Your Pronunciation
        <span class="rec-indicator" id="practiceRecInd"><span class="rec-dot"></span> Recording</span>
      </div>
      <div class="btn-row2">
        <button class="btn-danger" id="practiceRecBtn" onclick="togglePracticeRec()">ğŸ¤ Record</button>
        <span class="timer-txt" id="practiceTimerTxt"></span>
      </div>
      <audio id="practicePlayer" controls></audio>
    </div>

    <div style="font-size:.76rem;color:var(--muted);margin-top:-8px;">Max 5 seconds Â· compare your attempt with the correct pronunciation above</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEMES = [
  {
    id:'stories', name:'ğŸ“– Stories',
    passages:[
      {
        id:'s1', title:'The Tortoise and the Hare', level:'easy',
        text:'Once upon a time a hare challenged a tortoise to a race. Everyone laughed because the tortoise was so slow. The hare sprinted ahead and soon he was far in the lead. Feeling sure of himself, he stopped under a shady tree and fell fast asleep. The tortoise never stopped. One steady step at a time, he plodded along the dusty path. When the hare finally woke up he dashed to the finish line as fast as his legs could carry him. But the tortoise was already there, smiling quietly. Slow and steady wins the race.'
      },
      {
        id:'s2', title:'The Selfish Giant', level:'medium',
        text:'Every afternoon when children came home from school they played in the giant\'s beautiful garden. It had soft green grass and peach trees that burst into blossom every spring. But one day the giant returned from a long journey and drove the children away. He built a high stone wall around the garden and put up a sign that said keep out. After that spring never came to his garden. Snow covered the flowers and frost crept across the trees. The birds refused to sing. The giant sat alone and cold inside his great house. One morning he heard a delicate sound drifting through the window. He looked out and saw that the children had crept back through a small hole in the wall. In every corner where a child had climbed, the trees had burst into blossom.'
      },
      {
        id:'s3', title:'The Lighthouse Keeper', level:'hard',
        text:'For forty years Thomas had kept the lamp burning on the rocky headland above the bay. Sailors from distant ports knew his lighthouse as a faithful star. On the night of the great storm, when waves crashed thirty feet above the dock and the wind howled like something living, Thomas climbed the iron staircase for what he sensed would be the last time. He had kept his promise to the sea and to the men who sailed it. What no one in the village ever knew was that on a stormy night long ago, his own father\'s ship had been guided safely into harbor by that same light. Every night since then, keeping the lamp had been not merely a duty but an act of love quietly repaid across the years.'
      }
    ]
  },
  {
    id:'motivational', name:'ğŸ”¥ Motivational',
    passages:[
      {
        id:'m1', title:'Every Step Forward', level:'easy',
        text:'You do not have to be perfect to start. You just have to start. Every great journey begins with a single step forward. When things feel too hard, take a breath and try once more. Small progress is still progress. Each time you try you learn something new. Each time you fall you grow a little stronger. The most successful people in the world were not born knowing everything. They worked hard, made mistakes, and kept going. Believe in yourself even when things feel impossible. Your effort today is building the person you will become tomorrow. Keep going. You are closer than you think.'
      },
      {
        id:'m2', title:'Rising After Failure', level:'medium',
        text:'Failure is not the opposite of success. It is a part of success. Every inventor, artist, and leader has faced moments of defeat. Thomas Edison failed more than a thousand times before he produced a working lightbulb. He described each failure not as a setback but as one more thing he had learned. When you stumble and fall you discover things about yourself that comfort and ease can never teach you. The sting of failure sharpens your focus, clarifies your goals, and deepens your determination. Do not be afraid of falling short. Be afraid only of never trying at all. The courage to begin again after failure is one of the most powerful forces a person can possess.'
      },
      {
        id:'m3', title:'The Language of Courage', level:'hard',
        text:'Courage is not the absence of fear. It is the recognition that something matters more than the fear you feel in a given moment. Throughout history the most transformative acts of human bravery have been performed by ordinary men and women who were deeply afraid yet chose to act anyway. They spoke when silence would have been safer. They stood when sitting would have been easier. They built bridges across chasms that others believed uncrossable. This is the nature of true courage. It is quiet, deliberate, and profoundly human. The world does not need fearless people. It needs people who understand their fear, acknowledge it honestly, and choose to move forward in spite of it. That choice, made again and again, is how lives and histories are changed.'
      }
    ]
  },
  {
    id:'communication', name:'ğŸ’¬ Communication',
    passages:[
      {
        id:'c1', title:'Meeting Someone New', level:'easy',
        text:'Hello, my name is Alex and I am very pleased to meet you. I work as a teacher at a local primary school. I have been teaching for about five years now and I love it. Working with children and helping them discover new things is the most rewarding part of my day. In my free time I enjoy reading, cooking, and going for long walks in the park. I moved to this city two years ago and I have been made to feel very welcome here. Everyone I have met has been so kind and friendly. I hope we have the chance to get to know each other better. Please feel free to ask me anything at all.'
      },
      {
        id:'c2', title:'Giving a Presentation', level:'medium',
        text:'Good morning everyone and thank you for taking the time to join us today. I would like to talk about something I believe is important for all of us. Over the next few minutes I will share key findings from our recent research and explain how they might shape the way we work going forward. I will begin with a brief overview of the background, then walk through the main results, and close with some thoughts on what we might do next. Please feel free to ask questions at any point during the talk. Your questions and perspectives are always valuable and I genuinely look forward to hearing them. So without further delay, let us get started.'
      },
      {
        id:'c3', title:'Navigating Difficult Conversations', level:'hard',
        text:'There are moments in professional and personal life when we must engage with perspectives that challenge our own deeply held beliefs. In these moments the quality of our listening matters far more than the persuasiveness of our speaking. Effective communication in difficult circumstances requires us to create space for the other person\'s experience without feeling immediately compelled to defend or justify our own position. It demands that we distinguish between the content of what is being said and the emotional intensity with which it is delivered. When we can hold that distinction steady, we open the possibility of genuine understanding. And genuine understanding, even when it does not lead to agreement, is always the foundation of a productive and respectful dialogue.'
      }
    ]
  },
  {
    id:'general', name:'ğŸŒ General',
    passages:[
      {
        id:'g1', title:'Weather Around the World', level:'easy',
        text:'The weather around the world can be very different depending on where you live. In some countries the sun shines nearly every day and temperatures stay warm all year round. In other places there are four distinct seasons. Spring brings flowers and mild breezes. Summer is hot and bright. Autumn turns the leaves red and gold. Winter brings cold winds and sometimes snow. Near the equator the climate is hot and wet, and thick rainforests grow because so much rain falls throughout the year. Near the poles it is always cold and covered in ice. People who live in these extreme places have found clever ways to keep warm and to build shelter against the harsh conditions.'
      },
      {
        id:'g2', title:'How the Internet Works', level:'medium',
        text:'When you send a message online or load a webpage, the information travels across a vast global network of cables, routers, and servers. Your device breaks the data into small packets, each labeled with a destination address. These packets may travel by entirely different routes, crossing fiber-optic cables laid under oceans or bouncing through wireless signals in the air. At every step, routers read each packet\'s address and direct it forward, much like a post office sorting millions of letters at once. When all the packets arrive your device reassembles them into the original message or page. This entire process typically takes less than one second, allowing billions of people around the world to communicate and share information almost instantly.'
      },
      {
        id:'g3', title:'The Human Brain', level:'hard',
        text:'The human brain is arguably the most complex structure in the known universe. Weighing approximately three pounds and consuming roughly twenty percent of the body\'s total energy despite comprising only two percent of its mass, the brain coordinates every conscious and unconscious process that sustains human life. It contains approximately eighty-six billion neurons, each capable of forming thousands of synaptic connections, creating a network of staggering computational power. The prefrontal cortex, located directly behind the forehead, governs executive functions such as planning, decision-making, and impulse control. The limbic system, nestled deeper within, regulates emotion and memory. Modern neuroscience continues to show that the brain remains remarkably adaptable throughout life, a property known as neuroplasticity, meaning that learning and experience can physically reshape its structure even in adulthood.'
      }
    ]
  },
  {
    id:'sympathetic', name:'ğŸ’œ Sympathetic',
    passages:[
      {
        id:'sy1', title:'A Note to a Friend', level:'easy',
        text:'I know that right now things feel really difficult for you. I want you to know that I am here. You do not have to face any of this alone. When you feel sad or lost or overwhelmed, please reach out. I will always listen without judgment and without trying to rush you through what you are feeling. Some days are heavy and that is completely okay. It is okay to cry. It is okay to say that you are struggling. Asking for support is one of the bravest things a person can do. You have been there for so many people. Please let us be here for you now. Whatever you need, I am not going anywhere. You matter more than you know.'
      },
      {
        id:'sy2', title:'Words for a Difficult Time', level:'medium',
        text:'Grief does not follow a schedule or a neat and tidy path. It arrives without warning, sometimes long after you believed it had passed. There is no right or wrong way to move through loss. Some days you may feel surprisingly strong and clear-headed. Other days the weight of what you carry may feel completely unbearable. Both of those experiences are entirely valid and both deserve to be honoured. What matters most is that you allow yourself to feel what you feel without rushing toward some imagined finish line. Time does not always heal everything, but it does slowly change the shape of things. Gradually the pain that once felt sharp and constant may become something softer, something that you can carry with more ease.'
      },
      {
        id:'sy3', title:'On Empathy and Human Connection', level:'hard',
        text:'To truly empathise with another person is one of the most demanding and most beautiful things we can do as human beings. It requires us to set aside the natural impulse to offer quick solutions, to compare experiences, or to minimise what the other person is feeling. It asks us instead to enter as fully as we are able into the emotional reality of someone else\'s life. This is not a passive act. It demands concentration, humility, and a willingness to sit with discomfort alongside the person who is suffering. When we offer genuine empathy we do not promise that things will improve or that the pain will end. We say simply, with our presence and attention, that this person\'s experience matters and that they are not invisible. In a world that often moves too fast to notice one another\'s pain, that quiet act of faithful attention is among the most profound gifts we can give.'
      }
    ]
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentThemeId  = THEMES[0].id;
let currentPassage  = THEMES[0].passages[0];
let recognition     = null;
let isRecording     = false;
let finalText       = '';
let startTime       = null;
let recordInterval  = null;
let recordSeconds   = 0;

// MediaRecorder
let micStream       = null;
let mediaRecorder   = null;
let audioChunks     = [];
let recordingBlob   = null;
let replayBlobUrl   = null;

// iOS proactive restart (avoid forced ~60s timeout)
let proactiveRestartTimer = null;

// Practice modal
let practiceWordStr    = '';
let practiceStream     = null;
let practiceRecorder   = null;
let practiceIsRecording= false;
let practiceTimerInt   = null;
let practiceSecsLeft   = 5;
let practiceBlobUrl    = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM REFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const themeTabsEl   = document.getElementById('themeTabs');
const passageGrid   = document.getElementById('passageGrid');
const passageTitle  = document.getElementById('passageTitle');
const passageTextEl = document.getElementById('passageText');
const recordBtn     = document.getElementById('recordBtn');
const statusText    = document.getElementById('statusText');
const resetBtn      = document.getElementById('resetBtn');
const transcriptEl  = document.getElementById('transcriptText');
const resultsCard   = document.getElementById('resultsCard');
const replayRow     = document.getElementById('replayRow');
const replayAudio   = document.getElementById('replayAudio');
const gradeBadge    = document.getElementById('gradeBadge');
const scoreAccuracy = document.getElementById('scoreAccuracy');
const scoreWords    = document.getElementById('scoreWords');
const scoreWPM      = document.getElementById('scoreWPM');
const accuracyBar   = document.getElementById('accuracyBar');
const wordAnalysis  = document.getElementById('wordAnalysis');
const tipBox        = document.getElementById('tipBox');
const browserNotice = document.getElementById('browserNotice');
const practiceModal = document.getElementById('practiceModal');
const practiceWordDisplay = document.getElementById('practiceWordDisplay');
const practiceRecBtn      = document.getElementById('practiceRecBtn');
const practiceRecInd      = document.getElementById('practiceRecInd');
const practiceTimerTxt    = document.getElementById('practiceTimerTxt');
const practicePlayer      = document.getElementById('practicePlayer');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BROWSER CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
const hasMediaRecorder     = !!(window.MediaRecorder && navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
const hasTTS               = !!window.speechSynthesis;
const isIOS                = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isMobile             = isIOS || /Android/i.test(navigator.userAgent);

// On mobile, file:// blocks speech recognition â€” must use HTTPS. Desktop Chrome/Edge is fine.
if (location.protocol === 'file:' && isMobile) {
  browserNotice.style.display = 'block';
  browserNotice.innerHTML = 'âš ï¸ On mobile, this app must be opened from a web address. '
    + 'Open it at <a href="https://daiboyi110.github.io/readalong/" style="color:#92400e;font-weight:700;">https://daiboyi110.github.io/readalong/</a>';
  recordBtn.disabled = true;
} else if (!SpeechRecognitionAPI) {
  browserNotice.style.display = 'block';
  browserNotice.innerHTML = isIOS
    ? 'âš ï¸ On iPhone/iPad, use <strong>Safari</strong> (iOS 16+). Speech recognition is not available in Chrome or Firefox on iOS.'
    : 'âŒ Speech recognition is not supported. Please open this page in <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong>.';
  recordBtn.disabled = true;
} else if (isMobile) {
  browserNotice.style.display = 'block';
  browserNotice.innerHTML = isIOS
    ? 'ğŸ“± iPhone/iPad (Safari only): Tap <strong>Allow</strong> when asked. The mic briefly pauses every ~50 seconds â€” when you see the â†º button, pause reading for 1 second then continue.'
    : 'ğŸ“± Android: When asked, tap <strong>Allow</strong> for microphone access. Chrome works best.';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME & PASSAGE UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderThemeTabs() {
  themeTabsEl.innerHTML = THEMES.map(t => `
    <button class="theme-tab ${t.id === currentThemeId ? 'active' : ''}"
            onclick="switchTheme('${t.id}')">${t.name}</button>
  `).join('');
}

function switchTheme(id) {
  if (isRecording) stopRecording();
  currentThemeId = id;
  const theme = THEMES.find(t => t.id === id);
  currentPassage = theme.passages[0];
  renderThemeTabs();
  renderPassageGrid();
  renderPassage();
  resetResults();
}

function renderPassageGrid() {
  const theme = THEMES.find(t => t.id === currentThemeId);
  passageGrid.innerHTML = theme.passages.map(p => `
    <div class="pcard ${p.id === currentPassage.id ? 'active' : ''}" onclick="selectPassage('${p.id}')">
      <div class="pcard-title">${p.title}</div>
      <span class="badge ${p.level}">${p.level}</span>
    </div>
  `).join('');
}

function selectPassage(id) {
  if (isRecording) stopRecording();
  const theme = THEMES.find(t => t.id === currentThemeId);
  currentPassage = theme.passages.find(p => p.id === id);
  renderPassageGrid();
  renderPassage();
  resetResults();
  // reset transcript
  finalText = '';
  transcriptEl.innerHTML = '<span class="placeholder">Your spoken words will appear here in real timeâ€¦</span>';
}

function renderPassage(matchedSet) {
  passageTitle.textContent = currentPassage.title;
  const words = currentPassage.text.split(/\s+/).filter(Boolean);
  if (matchedSet) {
    passageTextEl.innerHTML = words.map((w, i) =>
      `<span class="w ${matchedSet.has(i) ? 'correct' : 'incorrect'}">${w}</span>`
    ).join(' ');
  } else {
    passageTextEl.textContent = currentPassage.text;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPEECH RECOGNITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRecognition() {
  const r = new SpeechRecognitionAPI();
  r.continuous      = true;
  r.interimResults  = true;
  r.lang            = 'en-US';
  r.maxAlternatives = 1;

  let didStart = false; // tracks whether onstart ever fired for this instance

  r.onstart = () => {
    didStart = true;
    recordBtn.classList.remove('pausing');
    recordBtn.classList.add('recording');
    recordBtn.innerHTML = 'â¹';
    statusText.classList.add('live');
    statusText.textContent = 'ğŸ”´ Recording â€” read the passage aloud';
    startRecordTimer();

    // iOS: proactively restart at 50s so WE control the timing,
    // preventing the forced browser timeout at ~60s.
    if (isIOS) {
      clearTimeout(proactiveRestartTimer);
      proactiveRestartTimer = setTimeout(() => {
        if (isRecording && recognition) {
          recognition.stop(); // triggers onend â†’ clean restart
        }
      }, 50000);
    }
  };

  r.onresult = (e) => {
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) finalText += t + ' ';
      else interim = t;
    }
    transcriptEl.innerHTML =
      (finalText  ? `<span>${finalText}</span>` : '') +
      (interim    ? `<span class="interim">${interim}</span>` : '');
    transcriptEl.scrollTop = transcriptEl.scrollHeight;
  };

  r.onerror = (e) => {
    if (e.error === 'no-speech') return; // silence timeout â€” harmless, onend will restart
    if (e.error === 'network')   return; // transient on mobile â€” onend will restart
    if (e.error === 'audio-capture') {
      statusText.textContent = 'ğŸ™ï¸ Microphone not found. Check your device settings.';
      isRecording = false; resetRecordBtn(); return;
    }
    if (e.error === 'not-allowed') {
      statusText.textContent = isMobile
        ? 'ğŸš« Microphone blocked. Go to your browser Settings â†’ Site permissions â†’ Microphone and allow this page.'
        : 'ğŸš« Microphone access denied. Click the ğŸ”’ icon in the address bar to allow it.';
      isRecording = false;
      if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      resetRecordBtn();
    }
  };

  // On iOS each start() re-acquires the mic. Use a delay so the system banner
  // slides away, and create a FRESH instance every time (iOS rejects reuse).
  r.onend = () => {
    clearTimeout(proactiveRestartTimer);
    if (!isRecording) return;

    // Silent failure: onend fired but onstart NEVER fired â†’ mic was blocked
    if (!didStart) {
      isRecording = false;
      resetRecordBtn();
      stopRecordTimer();
      statusText.textContent = isIOS
        ? 'ğŸš« Microphone blocked. On your iPhone: Settings â†’ Safari â†’ Microphone â†’ set this site to Allow. Then reload and try again.'
        : 'ğŸš« Microphone access was blocked. Click the ğŸ”’ icon in your address bar, set Microphone to Allow, then try again.';
      return;
    }

    // Show "pausing" spinner on button so user knows to briefly pause reading
    if (isIOS) {
      recordBtn.classList.remove('recording');
      recordBtn.classList.add('pausing');
      recordBtn.innerHTML = 'â†º';
      statusText.textContent = 'â†º Mic refreshing â€” pause 1 second then keep readingâ€¦';
    }

    const delay = isIOS ? 600 : 250;
    setTimeout(() => {
      if (!isRecording) return;
      recognition = buildRecognition(); // fresh instance required on iOS
      try { recognition.start(); }
      catch(_) {}
    }, delay);
  };

  return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEDIA RECORDER (full-session audio capture)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getMimeType() {
  for (const t of ['audio/webm;codecs=opus','audio/webm','audio/ogg','audio/mp4']) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
  }
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECORDING CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startRecording() {
  if (!SpeechRecognitionAPI) return;

  finalText     = '';
  recordingBlob = null;
  transcriptEl.innerHTML = '<span class="placeholder">Startingâ€¦</span>';
  statusText.textContent  = isIOS ? 'Tap Allow when your browser asks for mic accessâ€¦'
                                  : 'Requesting microphone accessâ€¦';
  resetResults();

  // â”€â”€ Step 1: Single getUserMedia call â†’ one permission dialog covers everything â”€â”€
  // Skip on iOS: SpeechRecognition handles its own mic access there, and calling
  // getUserMedia separately causes an extra permission banner every restart.
  if (hasMediaRecorder && !isIOS) {
    try {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    } catch(err) {
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        statusText.textContent = 'ğŸš« Microphone access denied. Click the ğŸ”’ icon in your address bar to allow it.';
        transcriptEl.innerHTML = '<span class="placeholder">â€¦</span>';
        return;
      }
      micStream = null; // getUserMedia unavailable â€” fall back to SpeechRecognition only
    }
  }

  // â”€â”€ Step 2: Attach MediaRecorder to the stream we just got â”€â”€
  if (micStream) {
    try {
      const mime  = getMimeType();
      audioChunks = [];
      mediaRecorder = mime
        ? new MediaRecorder(micStream, { mimeType: mime })
        : new MediaRecorder(micStream);
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        recordingBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
      };
      mediaRecorder.start(200);
    } catch(err) {
      console.warn('MediaRecorder setup failed:', err);
    }
  }

  // â”€â”€ Step 3: Start SpeechRecognition â€” permission already granted above â”€â”€
  recognition = buildRecognition();
  try {
    recognition.start();
    isRecording = true;
    startTime   = Date.now();
    transcriptEl.innerHTML = '<span class="placeholder">Listeningâ€¦ read aloud now</span>';
    // onstart fires once the browser actually has mic access and updates statusText.
    // On iOS there can be a visible gap before onstart, so show a clear interim message.
    if (isIOS) statusText.textContent = 'ğŸ“± Allow mic access if asked, then start readingâ€¦';
  } catch(err) {
    statusText.textContent = `Could not start: ${err.message}`;
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  }
}

function stopRecording() {
  isRecording = false;
  clearTimeout(proactiveRestartTimer);
  stopRecordTimer();

  if (recognition) { recognition.stop(); recognition = null; }

  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    // Release mic track after recorder has flushed its final chunk
    setTimeout(() => {
      if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    }, 400);
  } else {
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
  }

  resetRecordBtn();
  statusText.textContent = 'Done! Your results are below â†“';

  setTimeout(() => {
    const full = finalText.trim();
    if (full) showResults(full);
    else       statusText.textContent = 'No speech detected â€” please try again.';
  }, 800);
}

function resetRecordBtn() {
  recordBtn.classList.remove('recording');
  recordBtn.innerHTML = 'ğŸ¤';
  statusText.classList.remove('live');
}

recordBtn.addEventListener('click', () => { isRecording ? stopRecording() : startRecording(); });
resetBtn.addEventListener('click',  () => { if (isRecording) stopRecording(); resetAll(); });

function resetAll() {
  isRecording = false;
  clearTimeout(proactiveRestartTimer);
  finalText   = '';
  startTime   = null;
  recordingBlob = null;
  if (replayBlobUrl) { URL.revokeObjectURL(replayBlobUrl); replayBlobUrl = null; }
  stopRecordTimer();
  resetRecordBtn();
  statusText.textContent = 'Click the microphone to start reading aloud';
  transcriptEl.innerHTML = '<span class="placeholder">Your spoken words will appear here in real timeâ€¦</span>';
  resetResults();
  renderPassage();
}

function resetResults() {
  resultsCard.classList.remove('visible');
  replayRow.style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECORD TIMER (clock display while recording)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startRecordTimer() {
  recordSeconds = 0;
  recordInterval = setInterval(() => {
    recordSeconds++;
    const m = String(Math.floor(recordSeconds / 60)).padStart(1,'0');
    const s = String(recordSeconds % 60).padStart(2,'0');
    statusText.textContent = `ğŸ”´ Recording  ${m}:${s}  â€” read the passage aloud`;
  }, 1000);
}

function stopRecordTimer() {
  if (recordInterval) { clearInterval(recordInterval); recordInterval = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEXT ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function normalizeWord(w) { return w.toLowerCase().replace(/[^a-z0-9']/g,''); }
function tokenize(text)   { return text.split(/\s+/).filter(Boolean).map(normalizeWord).filter(w => w.length > 0); }

function wordLCS(orig, trans) {
  const m = orig.length, n = trans.length;
  const dp = new Uint16Array((m+1)*(n+1));
  const I  = (i,j) => i*(n+1)+j;
  for (let i=1;i<=m;i++)
    for (let j=1;j<=n;j++)
      dp[I(i,j)] = orig[i-1]===trans[j-1] ? dp[I(i-1,j-1)]+1 : Math.max(dp[I(i-1,j)],dp[I(i,j-1)]);
  const matched = new Set();
  let i=m, j=n;
  while (i>0 && j>0) {
    if (orig[i-1]===trans[j-1]) { matched.add(i-1); i--; j--; }
    else if (dp[I(i-1,j)] >= dp[I(i,j-1)]) i--;
    else j--;
  }
  return { matched, lcsLen: dp[I(m,n)] };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOW RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResults(transcript) {
  const displayWords = currentPassage.text.split(/\s+/).filter(Boolean);
  const origNorm     = displayWords.map(normalizeWord);
  const transNorm    = tokenize(transcript);

  const { matched, lcsLen } = wordLCS(origNorm, transNorm);

  const total   = origNorm.length;
  const correct = lcsLen;
  const pct     = Math.round((correct / total) * 100);

  // WPM
  let wpm = 'â€”';
  if (startTime) {
    const mins = (Date.now() - startTime) / 60000;
    if (mins > 0) wpm = Math.round(transNorm.length / mins);
  }

  // Grade
  const [grade, gCls] =
    pct >= 95 ? ['A+','grade-Ap'] :
    pct >= 90 ? ['A', 'grade-A']  :
    pct >= 80 ? ['B', 'grade-B']  :
    pct >= 70 ? ['C', 'grade-C']  :
    pct >= 60 ? ['D', 'grade-D']  : ['F','grade-F'];

  gradeBadge.textContent = grade;
  gradeBadge.className   = `grade-badge ${gCls}`;
  scoreAccuracy.textContent = `${pct}%`;
  scoreWords.textContent    = `${correct}/${total}`;
  scoreWPM.textContent      = wpm;

  accuracyBar.style.width =
    pct >= 80 ? `${pct}%; background:linear-gradient(90deg,#10b981,#059669)` :
    `${pct}%`;
  accuracyBar.style.background =
    pct >= 80 ? 'linear-gradient(90deg,#10b981,#059669)' :
    pct >= 60 ? 'linear-gradient(90deg,#f59e0b,#d97706)' :
                'linear-gradient(90deg,#f87171,#dc2626)';
  accuracyBar.style.width = `${pct}%`;

  // Word chips
  wordAnalysis.innerHTML = '';
  displayWords.forEach((w, i) => {
    const isMatch = matched.has(i);
    const wrap = document.createElement('span');
    wrap.className = `wr ${isMatch ? 'match' : 'miss'}`;

    const txt = document.createElement('span');
    txt.textContent = w;
    wrap.appendChild(txt);

    if (!isMatch) {
      const cleanWord = normalizeWord(w);

      const ttsBtn = document.createElement('button');
      ttsBtn.className = 'wr-icon';
      ttsBtn.title = 'Hear correct pronunciation';
      ttsBtn.textContent = 'ğŸ”Š';
      ttsBtn.onclick = (e) => { e.stopPropagation(); ttsSpeak(cleanWord, 1); };

      const practiceBtn = document.createElement('button');
      practiceBtn.className = 'wr-icon';
      practiceBtn.title = 'Practice this word';
      practiceBtn.textContent = 'ğŸ¤';
      practiceBtn.onclick = (e) => { e.stopPropagation(); openModal(cleanWord); };

      wrap.appendChild(ttsBtn);
      wrap.appendChild(practiceBtn);
    }
    wordAnalysis.appendChild(wrap);
  });

  // Highlight passage
  renderPassage(matched);

  // Tip
  tipBox.textContent =
    pct >= 95 ? 'ğŸŒŸ Outstanding! You read with near-perfect accuracy. Excellent work!' :
    pct >= 85 ? 'ğŸ‘ Great job! A little more practice on the highlighted words and you\'ll nail it.' :
    pct >= 70 ? 'ğŸ“– Good effort! Focus on the red words â€” click ğŸ”Š to hear them, then ğŸ¤ to practise.' :
                'ğŸ’ª Keep going! Try listening to each missed word and record your own attempt to compare.';

  // Replay audio
  if (recordingBlob) {
    if (replayBlobUrl) URL.revokeObjectURL(replayBlobUrl);
    replayBlobUrl = URL.createObjectURL(recordingBlob);
    replayAudio.src = replayBlobUrl;
    replayRow.style.display = 'flex';
  }

  resultsCard.classList.add('visible');
  setTimeout(() => resultsCard.scrollIntoView({ behavior:'smooth', block:'start' }), 80);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ttsSpeak(word, rate) {
  if (!hasTTS) return;
  window.speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(word);
  utt.lang  = 'en-US';
  utt.rate  = rate;
  utt.pitch = 1;
  window.speechSynthesis.speak(utt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRACTICE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(word) {
  practiceWordStr = word;
  practiceWordDisplay.textContent = word;
  // Reset player
  practicePlayer.style.display = 'none';
  practicePlayer.src = '';
  if (practiceBlobUrl) { URL.revokeObjectURL(practiceBlobUrl); practiceBlobUrl = null; }
  practiceRecBtn.innerHTML = 'ğŸ¤ Record';
  practiceRecInd.classList.remove('show');
  practiceTimerTxt.textContent = '';
  practiceIsRecording = false;
  practiceModal.classList.add('open');
  // Auto-play TTS so user hears the target immediately
  setTimeout(() => ttsSpeak(word, 1), 300);
}

function closeModal() {
  if (practiceIsRecording) stopPracticeRec();
  practiceModal.classList.remove('open');
  window.speechSynthesis.cancel();
}

// Click outside modal card to close
practiceModal.addEventListener('click', e => { if (e.target === practiceModal) closeModal(); });

function speakPracticeWord(rate) { ttsSpeak(practiceWordStr, rate); }

async function togglePracticeRec() {
  if (practiceIsRecording) { stopPracticeRec(); return; }

  if (!hasMediaRecorder) {
    alert('Audio recording is not supported in this browser.');
    return;
  }

  try {
    practiceStream   = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mime       = getMimeType();
    practiceRecorder = mime ? new MediaRecorder(practiceStream, { mimeType: mime })
                            : new MediaRecorder(practiceStream);
    const chunks     = [];
    practiceRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
    practiceRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: practiceRecorder.mimeType || 'audio/webm' });
      if (practiceBlobUrl) URL.revokeObjectURL(practiceBlobUrl);
      practiceBlobUrl = URL.createObjectURL(blob);
      practicePlayer.src     = practiceBlobUrl;
      practicePlayer.style.display = 'block';
      if (practiceStream) { practiceStream.getTracks().forEach(t => t.stop()); practiceStream = null; }
    };
    practiceRecorder.start(100);
    practiceIsRecording = true;
    practiceRecBtn.innerHTML = 'â¹ Stop';
    practiceRecInd.classList.add('show');

    // countdown timer
    practiceSecsLeft = 5;
    practiceTimerTxt.textContent = `${practiceSecsLeft}s`;
    practiceTimerInt = setInterval(() => {
      practiceSecsLeft--;
      practiceTimerTxt.textContent = practiceSecsLeft > 0 ? `${practiceSecsLeft}s` : '';
      if (practiceSecsLeft <= 0) stopPracticeRec();
    }, 1000);

  } catch(err) {
    console.error('Practice record error:', err);
    alert('Could not access microphone: ' + err.message);
  }
}

function stopPracticeRec() {
  if (practiceTimerInt) { clearInterval(practiceTimerInt); practiceTimerInt = null; }
  if (practiceRecorder && practiceRecorder.state !== 'inactive') practiceRecorder.stop();
  practiceIsRecording = false;
  practiceRecBtn.innerHTML = 'ğŸ¤ Record again';
  practiceRecInd.classList.remove('show');
  practiceTimerTxt.textContent = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderThemeTabs();
renderPassageGrid();
renderPassage();
</script>
</body>
</html>
