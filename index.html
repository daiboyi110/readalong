<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ReadAlong â€” Reading Accuracy Trainer</title>
  <style>
    :root {
      --primary:       #5b21b6;
      --primary-lt:    #7c3aed;
      --primary-pale:  #ede9fe;
      --success:       #059669;
      --success-bg:    #d1fae5;
      --danger:        #dc2626;
      --danger-bg:     #fee2e2;
      --bg:            #f5f3ff;
      --card:          #ffffff;
      --text:          #1e1b4b;
      --muted:         #6b7280;
      --border:        #ddd6fe;
    }

    *          { margin:0; padding:0; box-sizing:border-box; }
    body       { font-family:'Segoe UI',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: linear-gradient(135deg,#4c1d95,#3730a3);
      color:#fff;
      padding:0 24px;
      position:sticky; top:0; z-index:50;
      box-shadow:0 4px 20px rgba(76,29,149,.4);
    }
    .header-top {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 0 10px;
    }
    .logo       { font-size:1.45rem; font-weight:800; letter-spacing:-.5px; }
    .logo em    { color:#c4b5fd; font-style:normal; }
    .tagline    { font-size:.8rem; opacity:.75; }
    .theme-tabs { display:flex; gap:2px; overflow-x:auto; padding-bottom:0; }
    .theme-tab  {
      padding:10px 15px; border:none; background:transparent;
      color:rgba(255,255,255,.6); cursor:pointer; font-size:.88rem; font-weight:500;
      border-bottom:3px solid transparent; white-space:nowrap; transition:all .2s;
    }
    .theme-tab:hover  { color:#fff; }
    .theme-tab.active { color:#fff; border-bottom-color:#c4b5fd; }

    /* â”€â”€ Browser notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #browserNotice {
      display:none; background:#fef9c3; border-bottom:2px solid #facc15;
      color:#713f12; padding:10px 24px; font-size:.85rem; text-align:center;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container { max-width:880px; margin:0 auto; padding:24px 16px 52px; display:flex; flex-direction:column; gap:20px; }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px 26px; box-shadow:0 2px 14px rgba(91,33,182,.07); }
    .card-label { font-size:.7rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:14px; }

    /* â”€â”€ Passage grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .passage-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:11px; }
    .pcard {
      border:2px solid var(--border); border-radius:12px; padding:14px 16px;
      cursor:pointer; transition:all .2s; background:#fafafa;
    }
    .pcard:hover        { border-color:var(--primary-lt); background:var(--primary-pale); }
    .pcard.active       { border-color:var(--primary-lt); background:var(--primary-pale); box-shadow:0 0 0 3px rgba(124,58,237,.14); }
    .pcard-title        { font-weight:600; font-size:.9rem; margin-bottom:6px; }
    .badge              { display:inline-block; padding:1px 8px; border-radius:20px; font-size:.67rem; font-weight:700; }
    .easy               { background:#d1fae5; color:#065f46; }
    .medium             { background:#fef3c7; color:#78350f; }
    .hard               { background:#fee2e2; color:#7f1d1d; }

    /* â”€â”€ Passage text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .passage-title { font-size:1rem; font-weight:700; color:var(--primary); margin-bottom:14px; }
    #passageText   { font-family:Georgia,serif; font-size:1.22rem; line-height:2.15; }
    .w             { display:inline; padding:1px 2px; border-radius:3px; transition:all .25s; }
    .w.correct     { background:var(--success-bg); color:#065f46; }
    .w.incorrect   { background:var(--danger-bg); color:#7f1d1d; text-decoration:line-through; }

    /* â”€â”€ Sentence-by-sentence mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .s-block           { display:block; font-family:Georgia,serif; font-size:1.22rem; line-height:2.1; padding:5px 10px; border-radius:6px; margin:3px 0; transition:all .3s; }
    .s-block.s-done    { opacity:.38; }
    .s-block.s-current { background:rgba(124,58,237,.13); border-left:3px solid var(--primary-lt); padding-left:14px; }
    .s-block.s-next    { opacity:.62; }
    #sentenceNav       { display:none; flex-direction:column; align-items:center; gap:10px; width:100%; }
    #sentenceNav.show  { display:flex; }
    .sentence-progress { font-size:.88rem; color:var(--primary); font-weight:700; }

    /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls      { display:flex; flex-direction:column; align-items:center; gap:14px; }
    #recordBtn {
      width:82px; height:82px; border-radius:50%; border:none; cursor:pointer;
      font-size:1.9rem; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,var(--primary-lt),var(--primary));
      color:#fff; box-shadow:0 6px 24px rgba(91,33,182,.35); transition:transform .25s;
    }
    #recordBtn:hover:not(:disabled) { transform:scale(1.06); }
    #recordBtn:disabled { opacity:.5; cursor:not-allowed; }
    #recordBtn.recording {
      background:linear-gradient(135deg,#f87171,var(--danger));
      box-shadow:0 6px 24px rgba(220,38,38,.4);
      animation:ripple 1.5s infinite;
    }
    #recordBtn.pausing {
      background:linear-gradient(135deg,#9ca3af,#6b7280);
      box-shadow:0 4px 14px rgba(0,0,0,.2);
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    @keyframes ripple {
      0%   { box-shadow:0 0 0 0   rgba(220,38,38,.45); }
      70%  { box-shadow:0 0 0 18px rgba(220,38,38,0);  }
      100% { box-shadow:0 0 0 0   rgba(220,38,38,0);   }
    }
    #statusText      { font-size:.9rem; font-weight:500; color:var(--muted); text-align:center; }
    #statusText.live { color:var(--danger); }
    .ghost-btn {
      padding:7px 18px; border-radius:8px; border:2px solid var(--border);
      background:transparent; cursor:pointer; font-size:.84rem; color:var(--muted); transition:all .2s;
    }
    .ghost-btn:hover { border-color:var(--primary-lt); color:var(--primary); }

    /* â”€â”€ Transcript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #transcriptText { font-size:1rem; line-height:1.85; min-height:64px; }
    .interim        { color:var(--muted); font-style:italic; }
    .placeholder    { color:#9ca3af; font-style:italic; }

    /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #resultsCard         { display:none; }
    #resultsCard.visible { display:block; }

    .results-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .results-title  { font-size:1.1rem; font-weight:800; }

    .grade-badge  { font-size:1.4rem; font-weight:800; padding:4px 14px; border-radius:10px; }
    .grade-Ap,.grade-A { background:#d1fae5; color:#065f46; }
    .grade-B               { background:#dbeafe; color:#1e40af; }
    .grade-C               { background:#fef3c7; color:#92400e; }
    .grade-D               { background:#ffedd5; color:#9a3412; }
    .grade-F               { background:#fee2e2; color:#991b1b; }

    /* replay */
    .replay-row {
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      background:var(--primary-pale); border-radius:12px; padding:12px 16px; margin-bottom:18px;
    }
    .replay-label { font-size:.82rem; font-weight:700; color:var(--primary); white-space:nowrap; }
    #replayAudio  { flex:1; min-width:180px; height:34px; }

    /* scores */
    .score-row  { display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .score-box  { flex:1; min-width:80px; text-align:center; padding:14px 8px; background:var(--primary-pale); border-radius:12px; }
    .score-value { font-size:1.75rem; font-weight:800; color:var(--primary); }
    .score-label { font-size:.67rem; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); margin-top:3px; }

    .bar-wrap    { background:#e5e7eb; border-radius:50px; height:12px; overflow:hidden; margin-bottom:20px; }
    #accuracyBar { height:100%; border-radius:50px; background:linear-gradient(90deg,#10b981,#059669); width:0%; transition:width 1s ease, background 1s; }

    /* word analysis */
    .analysis-wrap h4 { font-size:.7rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:10px; }
    .legend      { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px; }
    .legend-item { display:flex; align-items:center; gap:6px; font-size:.78rem; color:var(--muted); }
    .legend-dot  { width:12px; height:12px; border-radius:3px; }
    .wr-wrap     { line-height:2.6; }

    .wr {
      display:inline-flex; align-items:center; gap:3px;
      padding:3px 9px; margin:3px 2px; border-radius:6px;
      font-family:Georgia,serif; font-size:.9rem;
    }
    .wr.match { background:var(--success-bg); color:#065f46; }
    .wr.miss  { background:var(--danger-bg);  color:#7f1d1d; text-decoration:line-through; }
    .wr-icon {
      display:inline-flex; align-items:center; justify-content:center;
      width:20px; height:20px; border-radius:4px; border:none;
      cursor:pointer; font-size:.72rem; padding:0;
      background:rgba(220,38,38,.13); color:#991b1b; transition:background .15s;
    }
    .wr-icon:hover { background:rgba(220,38,38,.27); }

    .tip-box { margin-top:16px; padding:12px 16px; background:#f0fdf4; border-left:4px solid #10b981; border-radius:0 8px 8px 0; font-size:.85rem; color:#065f46; }

    /* â”€â”€ Practice modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #practiceModal {
      display:none; position:fixed; inset:0; z-index:200;
      background:rgba(15,10,40,.65); backdrop-filter:blur(5px);
      align-items:center; justify-content:center; padding:16px;
    }
    #practiceModal.open { display:flex; }
    .modal-card { background:#fff; border-radius:20px; padding:28px; width:100%; max-width:420px; box-shadow:0 24px 64px rgba(0,0,0,.28); }
    .modal-hdr  { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
    .modal-subtitle { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--muted); }
    .modal-word { font-family:Georgia,serif; font-size:2.1rem; font-weight:700; color:var(--primary); margin:4px 0 22px; }
    .modal-close { background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--muted); line-height:1; }
    .modal-close:hover { color:var(--text); }
    .modal-section { margin-bottom:20px; }
    .modal-sec-label { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .btn-row2       { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .btn-primary {
      padding:9px 18px; border-radius:10px; border:none; cursor:pointer;
      font-size:.88rem; font-weight:600; color:#fff;
      background:linear-gradient(135deg,var(--primary-lt),var(--primary));
      display:inline-flex; align-items:center; gap:5px; transition:opacity .2s;
    }
    .btn-primary:hover { opacity:.87; }
    .btn-danger  {
      padding:9px 18px; border-radius:10px; border:none; cursor:pointer;
      font-size:.88rem; font-weight:600; color:#fff;
      background:linear-gradient(135deg,#f87171,var(--danger));
      display:inline-flex; align-items:center; gap:5px; transition:opacity .2s;
    }
    .btn-danger:hover  { opacity:.87; }
    .btn-speed {
      padding:5px 12px; border-radius:6px; border:1.5px solid var(--border);
      background:transparent; cursor:pointer; font-size:.8rem; color:var(--muted); transition:all .2s;
    }
    .btn-speed:hover { border-color:var(--primary-lt); color:var(--primary); }

    #practicePlayer { display:none; margin-top:12px; width:100%; height:34px; }
    .word-result       { margin-top:12px; padding:10px 14px; border-radius:8px; font-size:.9rem; font-weight:600; display:none; }
    .word-result.correct { display:block; background:#d1fae5; color:#065f46; }
    .word-result.wrong   { display:block; background:#fee2e2; color:#991b1b; }
    #practiceListening { display:none; align-items:center; gap:7px; font-size:.85rem; color:var(--primary); font-weight:600; }
    #practiceListening.show { display:flex; }

    .rec-indicator       { display:none; align-items:center; gap:6px; font-size:.8rem; color:var(--danger); font-weight:600; }
    .rec-indicator.show  { display:flex; }
    .rec-dot             { width:8px; height:8px; border-radius:50%; background:var(--danger); animation:blink 1s infinite; }
    .timer-txt           { font-size:.8rem; color:var(--danger); font-weight:600; min-width:30px; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer { text-align:center; padding:0 0 24px; color:var(--muted); font-size:.77rem; }

    @media(max-width:520px){
      #passageText  { font-size:1.08rem; }
      .score-value  { font-size:1.4rem; }
      .passage-grid { grid-template-columns:1fr; }
      .modal-word   { font-size:1.6rem; }
    }
  </style>
</head>
<body>

<div id="browserNotice"></div>

<header>
  <div class="header-top">
    <div class="logo">Read<em>Along</em></div>
    <div class="tagline">Reading Accuracy Trainer</div>
  </div>
  <div class="theme-tabs" id="themeTabs"></div>
</header>

<div class="container">

  <!-- Passage picker -->
  <div class="card">
    <div class="card-label" id="passageGridLabel">Choose a Passage</div>
    <div class="passage-grid" id="passageGrid"></div>
    <div id="updatePassagesBtn" style="margin-top:14px;text-align:center;"></div>
  </div>

  <!-- Reading passage -->
  <div class="card">
    <div class="card-label">Reading Passage</div>
    <div class="passage-title" id="passageTitle"></div>
    <div id="passageText"></div>
  </div>

  <!-- Controls -->
  <div class="card controls">
    <button id="recordBtn" title="Start / Stop recording">ğŸ¤</button>
    <div id="statusText">Click the microphone to start reading aloud</div>
    <button class="ghost-btn" id="resetBtn">â†º Reset</button>
    <div id="sentenceNav">
      <div class="sentence-progress" id="sentenceProgress"></div>
      <button class="ghost-btn" id="nextSentenceBtn" onclick="advanceSentenceManually()">Next sentence â†’</button>
    </div>
  </div>

  <!-- Transcript -->
  <div class="card">
    <div class="card-label">Live Transcript</div>
    <div id="transcriptText"><span class="placeholder">Your spoken words will appear here in real timeâ€¦</span></div>
  </div>

  <!-- Results -->
  <div class="card" id="resultsCard">
    <div class="results-header">
      <div class="results-title">ğŸ“Š Reading Results</div>
      <div class="grade-badge" id="gradeBadge"></div>
    </div>

    <!-- Replay -->
    <div class="replay-row" id="replayRow" style="display:none">
      <div class="replay-label">ğŸ§ Replay Your Reading</div>
      <audio id="replayAudio" controls></audio>
    </div>

    <!-- Scores -->
    <div class="score-row">
      <div class="score-box"><div class="score-value" id="scoreAccuracy">â€”</div><div class="score-label">Accuracy</div></div>
      <div class="score-box"><div class="score-value" id="scoreWords">â€”</div><div class="score-label">Words Correct</div></div>
      <div class="score-box"><div class="score-value" id="scoreWPM">â€”</div><div class="score-label">Words / Min</div></div>
    </div>

    <div class="bar-wrap"><div id="accuracyBar"></div></div>

    <div class="analysis-wrap">
      <h4>Word-by-Word Analysis</h4>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-dot" style="background:var(--success-bg);border:1px solid #6ee7b7;"></div>
          Correctly read
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background:var(--danger-bg);border:1px solid #fca5a5;"></div>
          Missed â€” <strong>ğŸ”Š</strong> hear correct &nbsp;|&nbsp; <strong>ğŸ¤</strong> practice it
        </div>
      </div>
      <div class="wr-wrap" id="wordAnalysis"></div>
    </div>

    <div class="tip-box" id="tipBox"></div>
  </div>

</div><!-- .container -->

<footer>ReadAlong uses your browser's built-in speech recognition. Audio is processed locally and never sent to any server.</footer>

<!-- â”€â”€ Word Practice Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="practiceModal">
  <div class="modal-card">
    <div class="modal-hdr">
      <div>
        <div class="modal-subtitle">Word Practice</div>
        <div class="modal-word" id="practiceWordDisplay"></div>
      </div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>

    <!-- Correct pronunciation -->
    <div class="modal-section">
      <div class="modal-sec-label">ğŸ”Š Correct Pronunciation</div>
      <div class="btn-row2">
        <button class="btn-primary" onclick="speakPracticeWord(1)">ğŸ”Š Hear it</button>
        <button class="btn-speed"   onclick="speakPracticeWord(0.6)">ğŸ¢ Slowly</button>
      </div>
    </div>

    <!-- User attempt -->
    <div class="modal-section">
      <div class="modal-sec-label">
        ğŸ¤ Check Your Pronunciation
        <span id="practiceListening"><span class="rec-dot"></span> Listeningâ€¦</span>
      </div>
      <div class="btn-row2">
        <button class="btn-danger" id="practiceRecBtn" onclick="startWordCheck()">ğŸ¤ Say it</button>
      </div>
      <div class="word-result" id="wordResult"></div>
    </div>

    <div style="font-size:.76rem;color:var(--muted);margin-top:-8px;">Tap <strong>Say it</strong>, speak the word, and see if it was recognised correctly.</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEMES = [
  {
    id:'informative', name:'ğŸ“š Informative',
    passages:[
      { id:'i1', title:'The Water Cycle', level:'easy',
        text:'Water is always moving. It travels from the ground up into the sky and falls back down again in a never-ending cycle. When the sun heats water in rivers, lakes, and oceans, it turns into water vapour and rises into the air. This process is called evaporation. High up in the sky the vapour cools and forms tiny droplets that gather together to make clouds. This is called condensation. When the droplets become too heavy they fall back to earth as rain or snow. This is called precipitation. The water then flows into streams and rivers, soaks into the ground, or collects in lakes and oceans. Then the whole cycle begins again. Without the water cycle life on Earth could not exist.' },
      { id:'i2', title:'How Vaccines Work', level:'medium',
        text:'Vaccines are one of the most powerful tools in modern medicine. They work by training your immune system to recognize and fight specific diseases without you having to get sick first. When a vaccine is introduced into your body it contains either a weakened or inactive form of a virus or bacteria, or sometimes just a small piece of the pathogen such as a protein. Your immune system responds by producing antibodies and creating memory cells. These memory cells remain in your body long after the initial response. If you later encounter the real disease your immune system recognizes it immediately and responds quickly enough to prevent serious illness. This is why vaccinated populations experience far fewer outbreaks of dangerous diseases. Vaccines protect not only the individual but also the wider community through a principle known as herd immunity.' },
      { id:'i3', title:'The Nervous System', level:'hard',
        text:'The human nervous system is a remarkably sophisticated biological network responsible for coordinating virtually every function of the body. It is divided into two primary components: the central nervous system, comprising the brain and spinal cord, and the peripheral nervous system, which extends throughout the body via a vast web of nerves. Information travels through this network in the form of electrical signals called nerve impulses, which are transmitted between neurons across junctions called synapses. The brain processes incoming signals with extraordinary speed, integrating sensory data, regulating involuntary functions such as breathing and heart rate, and generating the conscious thoughts and voluntary movements that define our daily experience. The autonomic nervous system, a subdivision of the peripheral nervous system, governs involuntary processes and is itself divided into the sympathetic system, which prepares the body for action, and the parasympathetic system, which promotes rest and recovery.' },
      { id:'i4', title:'How Bees Make Honey', level:'easy',
        text:'Bees are remarkable insects that work together to make one of nature\'s sweetest foods. Worker bees fly from flower to flower collecting nectar, a sweet liquid found inside blooms. They carry the nectar back to the hive in a special honey stomach. Inside the hive they pass the nectar to other worker bees who chew it and pass it along several times. This process adds enzymes that break down the sugars in the nectar. The bees then spread the nectar into honeycomb cells and fan it with their wings to evaporate the water. When enough water has evaporated the honey is thick and ready. The bees seal each cell with a wax cap to keep it fresh. A healthy hive can produce more than fifty pounds of honey in a single year.' },
      { id:'i5', title:'The Printing Press', level:'medium',
        text:'Before Johannes Gutenberg invented the printing press around 1440, books were copied by hand, a process that took months or even years. Only the very wealthy or the Church could afford them. Gutenberg\'s invention used movable metal type that could be arranged to form any text, inked, and pressed onto paper in large quantities. Within decades of its invention printing presses had spread across Europe and millions of books were in circulation. For the first time in history information could travel rapidly across cities and countries. The printing press played a direct role in the Protestant Reformation, the Scientific Revolution, and the spread of literacy. It democratized knowledge, breaking the monopoly that religious and royal institutions had long held over education and information. Many historians regard it as the single most transformative technological invention of the last thousand years.' },
      { id:'i6', title:'Climate and the Carbon Cycle', level:'hard',
        text:'The carbon cycle is the natural process by which carbon moves between the atmosphere, oceans, soil, and living organisms. For millions of years this cycle maintained a relatively stable balance, with carbon released through volcanic activity and respiration being absorbed by plants, oceans, and soil. Human industrial activity has disrupted this balance profoundly. The burning of fossil fuels releases carbon dioxide that has been stored underground for hundreds of millions of years, effectively injecting ancient carbon into the modern atmosphere far faster than natural systems can absorb it. Atmospheric concentrations of carbon dioxide have risen by more than forty percent since the Industrial Revolution, trapping additional heat through the greenhouse effect. The consequences are already visible in rising global temperatures, shifting precipitation patterns, retreating glaciers, and more frequent extreme weather events. Addressing climate change requires not only reducing emissions but also restoring the natural carbon sinks such as forests, wetlands, and healthy oceans that have historically buffered the cycle.' }
    ]
  },
  {
    id:'persuasive', name:'ğŸ¯ Persuasive',
    passages:[
      { id:'p1', title:'Why Reading Every Day Matters', level:'easy',
        text:'Reading every day is one of the best habits you can build. Even just fifteen or twenty minutes a day can make a big difference. When you read regularly you learn new words and ideas. Your brain gets stronger because reading challenges you to think and imagine. Books can take you to places you have never been and introduce you to people you could never meet in real life. Reading helps you understand the world better and makes it easier to express your own thoughts clearly. Studies show that people who read often do better at school and at work. They are also more creative and better at solving problems. Reading before bed can even help you sleep better. There are books about every topic imaginable. Whatever you are curious about there is a book waiting for you. Make time to read every single day.' },
      { id:'p2', title:'The Case for Regular Exercise', level:'medium',
        text:'We live in an age where sitting still has become the norm. Most of us spend the majority of our waking hours seated at desks, in cars, or on sofas. Yet the evidence for the transformative benefits of regular physical activity has never been stronger. Exercise reduces the risk of heart disease, type two diabetes, and several forms of cancer. It strengthens bones and muscles, improves sleep quality, and boosts immune function. Perhaps most compellingly, physical activity has a profound effect on mental health. Regular exercise reduces anxiety and depression as effectively as medication in many cases, and it does so without side effects. The barrier to beginning is low. Research consistently shows that even thirty minutes of moderate activity five days a week is enough to produce significant health benefits. Walking, cycling, swimming, or dancing all qualify. The question is not whether exercise is worth the time. The question is whether we can afford to keep neglecting it.' },
      { id:'p3', title:'Why Critical Thinking Matters Most', level:'hard',
        text:'In an era saturated with information, the ability to think critically has become not merely an academic virtue but a survival skill. We are exposed daily to an unprecedented volume of claims, arguments, data, and narratives, many of which are incomplete, misleading, or deliberately false. Without the capacity to evaluate sources, identify logical fallacies, distinguish correlation from causation, and resist the pull of cognitive biases, we become passive consumers of whatever information confirms what we already believe. The consequences are not abstract. Poor critical thinking at the individual level leads to poor decisions in health, finance, and relationships. At the collective level it enables the spread of misinformation, the manipulation of democratic processes, and the erosion of shared standards of evidence. Teaching people to think critically does not make them cynical or contrarian. It makes them more intellectually honest, more open to revision, and more capable of engaging productively with perspectives different from their own.' },
      { id:'p4', title:'Why Sleep Matters', level:'easy',
        text:'Sleep is not a luxury. It is something your body and brain need to work properly. When you do not get enough sleep everything feels harder. You find it more difficult to concentrate, remember things, and make good decisions. You feel more irritable and less patient with the people around you. Over time not getting enough sleep can cause serious health problems including a higher risk of heart disease and diabetes. Most adults need between seven and nine hours of sleep each night. Children and teenagers need even more. Good sleep starts with a regular bedtime routine. Going to bed at the same time each night and keeping your bedroom cool and dark can make a real difference. Put your phone away at least an hour before bed. Your brain needs time to slow down and prepare for rest. When you sleep well you feel better, think better, and live better.' },
      { id:'p5', title:'Benefits of a Second Language', level:'medium',
        text:'Learning a second language is one of the most rewarding investments you can make in yourself, and the benefits extend far beyond being able to order food abroad. Research consistently shows that bilingual individuals have stronger executive function, meaning they are better at switching between tasks, filtering out irrelevant information, and sustaining attention. Learning a language forces the brain to manage two competing systems simultaneously, building cognitive flexibility that carries over into other areas of life. There is also compelling evidence that bilingualism delays the onset of dementia by several years, suggesting that the mental exercise of operating in two languages builds cognitive reserves. Beyond the neurological benefits, speaking another language opens doors professionally and socially. It allows deeper engagement with other cultures, fosters empathy, and makes you a more effective communicator in your first language as well.' },
      { id:'p6', title:'Protecting Biodiversity', level:'hard',
        text:'Biodiversity, the extraordinary variety of life that inhabits our planet, is not merely a source of aesthetic wonder. It is the foundation upon which all human prosperity rests. Healthy ecosystems regulate the climate, purify water, pollinate crops, cycle nutrients through the soil, and buffer communities against floods and disease. Each species plays a functional role in these systems, and when species are lost the systems become less stable and less resilient. We are currently presiding over what scientists describe as the sixth mass extinction event in Earth\'s history, driven not by a meteor or volcanic catastrophe but by habitat destruction, pollution, overexploitation, invasive species, and climate change. The economic argument for protecting biodiversity is alone compelling: ecosystem services have been valued at tens of trillions of dollars annually. But the ethical case is equally powerful. We share this planet with millions of species, none of which evolved to serve our purposes. Protecting biodiversity is a moral obligation and a practical necessity for the long-term survival of human civilization.' }
    ]
  },
  {
    id:'entertaining', name:'ğŸ­ Entertaining',
    passages:[
      { id:'e1', title:'The Day I Tried to Bake a Cake', level:'easy',
        text:'I had never baked a cake before but I was certain it would be easy. How hard could it be? I followed the recipe carefully, or so I thought. I mixed the flour, eggs, sugar, and butter together in a big bowl and poured it into the tin. Forty minutes later the kitchen was filled with a strange smell and a cloud of smoke. I opened the oven to find something that looked less like a cake and more like a small volcano. The outside was completely black. The inside, when I cut it open, was still raw and wobbly. My dog took one sniff and walked away. I later discovered that I had used salt instead of sugar and forgotten to add the baking powder altogether. I ordered a pizza that evening. But I learned two very important lessons that day. Always read the labels. And always have a backup plan.' },
      { id:'e2', title:'My Most Embarrassing Travel Story', level:'medium',
        text:'I have traveled to many places and collected many stories but none quite compares to the afternoon I spent lost in a foreign city with a phone that had run out of battery, a phrase book in the wrong language, and an urgent need to find a bathroom. I had confidently told my travel companions that I knew a shortcut back to the hotel. Twenty minutes later I was standing in what appeared to be someone\'s private garden, being observed by a very unimpressed goat. A kind elderly woman eventually took pity on me and through an elaborate performance of mime that I will never forget directed me to both the bathroom and the correct street. When I finally made it back to the hotel my companions had already eaten dinner, ordered dessert, and were halfway through a card game. They have never let me forget the shortcut. And honestly, they should not.' },
      { id:'e3', title:'The Art of a Perfect Road Trip', level:'hard',
        text:'There is a particular kind of freedom that belongs only to the open road. Not the frantic freedom of an airport departure gate, or the organized freedom of a package tour with a laminated itinerary. The freedom of a road trip is messier, slower, and infinitely more interesting. It is the freedom of the wrong turn that leads you to a roadside diner where the coffee is terrible but the owner tells you a story that stays with you for years. The freedom of arriving somewhere you had no intention of visiting and finding it inexplicably perfect. The best road trips share a handful of qualities. The route is planned loosely enough to allow for deviation. The playlist is long enough to accommodate every mood from melancholy to euphoric. And the company, if there is any, is the kind that can sit in comfortable silence for two hours and then talk continuously for the next two. Everything else, including the destination, is negotiable. The journey is the point.' },
      { id:'e4', title:'A Very Unexpected Pet', level:'easy',
        text:'Last spring my neighbour knocked on my door holding a cardboard box with small holes in the lid. She was moving abroad and needed someone to look after her pet for two weeks. I assumed it would be a cat or perhaps a rabbit. It was not. Inside the box was a tortoise named Gerald who was approximately forty years old, weighed more than I expected, and had a personality that can only be described as deeply unimpressed with everything. Gerald did not want to eat the lettuce I offered. Gerald did not want to explore the garden. Gerald did not appear to want anything at all except to sit under the radiator and glare at me. After two weeks I returned him when she came back. She asked if he had been any trouble. I said no. Gerald stared at me with his ancient knowing eyes. I am fairly sure we both knew I was lying.' },
      { id:'e5', title:'The Night Everything Went Wrong', level:'medium',
        text:'There are evenings when nothing goes according to plan, and then there are evenings so comprehensively derailed that they eventually become stories you tell for the rest of your life. My friend\'s thirtieth birthday dinner was the second kind. The reservation had been made at the wrong restaurant on the wrong street in the wrong part of the city. We discovered this only after arriving and finding a completely different party in full celebration at our reserved table. The restaurant we had actually booked had given our table to someone else when we failed to appear on time. We ended up eating in a tiny noodle shop that had exactly three tables, mismatched chairs, and no menu beyond whatever the owner felt like cooking that evening. It turned out to be the best meal any of us had eaten in years. My friend says it is the only birthday dinner she has never forgotten.' },
      { id:'e6', title:'Why I Will Never Trust a GPS Again', level:'hard',
        text:'I should say at the outset that I have nothing against technology. I use it enthusiastically and gratefully in most areas of my life. But there exists between me and GPS navigation a specific and deeply personal conflict that began on a foggy Tuesday morning when I was directed, with absolute confidence and zero irony, straight into a lake. Not metaphorically. Literally. The device informed me that I should continue straight ahead for three hundred metres, and I, having not yet developed the healthy scepticism that I now bring to all machine-generated instructions, followed its advice to the point where the road ended and the water began. My car survived. My dignity did not. There is a lesson here about the difference between data and wisdom, about the limitations of systems that know coordinates but not context. Navigation requires judgement. Judgement, unfortunately, has not yet been successfully uploaded.' }
    ]
  },
  {
    id:'demonstrative', name:'ğŸ›  Demonstrative',
    passages:[
      { id:'d1', title:'How to Make a Cup of Tea', level:'easy',
        text:'Making a perfect cup of tea is simple when you follow a few easy steps. Start by filling your kettle with fresh cold water and bringing it to a boil. While the water is heating, warm your mug by rinsing it with a little hot water and then emptying it. This helps your tea stay warm longer. Place your tea bag into the mug. When the water has boiled pour it over the tea bag and let it steep for three to five minutes, depending on how strong you like your tea. The longer you leave it the stronger the flavour will be. Remove the tea bag without squeezing it, as squeezing can make the tea taste bitter. Add milk, sugar, or lemon if you prefer. Stir gently and let it cool for a moment before drinking. The best cup of tea is the one made exactly to your taste.' },
      { id:'d2', title:'How to Give a Great First Impression', level:'medium',
        text:'First impressions form within seconds and can shape a relationship for years. Fortunately the elements that create a strong first impression are straightforward and entirely within your control. Begin with your appearance. You do not need to dress expensively, but dressing appropriately for the context signals that you have put thought into the encounter. When you meet someone make steady and natural eye contact and offer a firm, brief handshake. Smile genuinely rather than performing a fixed social grin. When the other person speaks, listen actively. This means resisting the urge to formulate your response while they are still talking. Nod, maintain open body language, and ask a follow-up question that shows you have actually heard what they said. Use the person\'s name once during the early part of the conversation. The most powerful thing you can do in any introduction is make the other person feel seen and worth listening to.' },
      { id:'d3', title:'How to Manage Your Time', level:'hard',
        text:'Effective time management is not about cramming more activity into each day. It is about ensuring that the time you spend is directed toward the things that matter most. The first and most important step is to distinguish between tasks that are urgent and those that are important, because these two categories overlap far less often than most people assume. Email, interruptions, and minor requests create a constant sense of urgency while consuming time that could be given to work with lasting value. Blocking time in your calendar for deep focused work before you allow reactive tasks to intrude is among the most powerful practices available. Equally important is learning to say no clearly and without apology when requests do not align with your priorities. Review your commitments regularly and ruthlessly. An obligation that made sense six months ago may no longer deserve your time. Managing your time well is ultimately an act of managing your attention, and attention is the most finite resource any of us possesses.' },
      { id:'d4', title:'How to Plant a Seed', level:'easy',
        text:'Planting a seed is one of the most satisfying things you can do, and it is easier than you might think. Start by choosing a small pot with a hole in the bottom for drainage. Fill it with potting soil, leaving about two centimetres of space at the top. Read the seed packet to find out how deep to plant your seed. As a general rule small seeds go just below the surface and larger seeds go deeper. Make a small hole with your finger, drop in one or two seeds, and cover them gently with soil. Give the pot a good drink of water but do not flood it. Seeds need moisture to wake up and start growing. Place the pot in a warm spot with plenty of natural light. Check the soil every day and water it lightly whenever it feels dry. In just a few days you should see a small green shoot pushing through the soil. That first sign of life is one of the most encouraging sights in the world.' },
      { id:'d5', title:'How to Write a Compelling Email', level:'medium',
        text:'Most of the emails we send and receive every day are longer than they need to be, less clear than they could be, and less likely to produce a response than their senders hope. Writing a compelling email comes down to a handful of consistent principles. Start with a subject line that tells the reader exactly what the email is about and why it matters to them. Keep your opening sentence direct. Do not begin with pleasantries that the reader has to scroll past to find the actual point. State your purpose in the first two sentences. If you need the reader to take action make that action explicit. Be specific about what you are asking for and by when. Keep paragraphs short, ideally no more than three sentences each, so the email is easy to scan. Before sending, read it once from the recipient\'s perspective and ask whether someone unfamiliar with the context could understand it and act on it immediately. If the answer is no, revise until it is.' },
      { id:'d6', title:'How to Build a Daily Routine', level:'hard',
        text:'The architecture of a productive life is largely invisible to observers. What appears from the outside as exceptional talent or extraordinary willpower is, on closer inspection, usually the result of consistent daily habits executed so reliably that they require almost no conscious effort. Building a strong routine begins with designing your mornings. The first hour after waking has disproportionate influence on the quality of the rest of the day. Protecting it from the immediate pull of notifications, news, and reactive tasks allows you to approach the day from a position of intention rather than response. Identify two or three non-negotiable practices that you will complete each morning regardless of circumstance. Anchor your most cognitively demanding work to the time of day when your focus is naturally sharpest, and protect that window as you would a critical appointment. A routine well-designed does not constrain your freedom. It creates the conditions in which meaningful work and genuine rest both become possible.' }
    ]
  },
  {
    id:'ceremonial', name:'ğŸ› Ceremonial',
    passages:[
      { id:'ce1', title:'A Welcome Address', level:'easy',
        text:'Good morning and welcome everyone. It is wonderful to see so many familiar faces gathered here today, and we are delighted to welcome those of you who are joining us for the first time. Today is a day we have all been looking forward to. It brings together people who share a common purpose and a genuine care for what we are trying to build together. Events like this one remind us of the importance of coming together, of pausing in the middle of our busy lives to connect with one another face to face. We are grateful to each of you for making the time to be here. Your presence today means a great deal. Over the course of this morning we will hear from several wonderful speakers and have plenty of time to talk with one another. We hope you will leave feeling inspired, energised, and glad that you came. Once again, welcome. We are so pleased you are here.' },
      { id:'ce2', title:'A Toast at a Wedding', level:'medium',
        text:'Ladies and gentlemen, please raise your glasses. I have known the groom since we were both eleven years old and considerably less sensible than we are today, which gives me perhaps too much material and just enough wisdom to know which parts of it to leave out. What I will say is this. I have watched my friend face challenges that would have stopped many people in their tracks, and every time without fail he has met them with patience, humour, and a stubbornness that I used to find frustrating and now recognise as one of his finest qualities. When he told me he had met someone who made him want to be a better person I knew this was serious. Having come to know his partner over these past few years I understand completely. You are quite simply the right people for each other at the right time in each other\'s lives. To a future filled with every happiness. Ladies and gentlemen, the bride and groom.' },
      { id:'ce3', title:'An Acceptance Speech', level:'hard',
        text:'I want to begin by saying what everyone in this room who has ever stood in this position knows to be true: no award of this kind is ever the achievement of a single person. It is the accumulated result of everyone who believed in the work before it was finished, everyone who offered their time, expertise, and encouragement when the work was difficult and the outcome uncertain, and everyone whose own contributions made the work possible in the first place. I am deeply grateful to this organization for its generosity and for the seriousness with which it takes the work we are all trying to do. I am grateful to my colleagues, whose judgment I trust more than my own. And I am grateful to the people whose stories and experiences are at the centre of everything I do. Their willingness to be known and to trust that something worthwhile might come from that trust is the foundation on which all the rest of it rests. This recognition belongs to all of them.' },
      { id:'ce4', title:'Opening Remarks at a School Event', level:'easy',
        text:'Good afternoon everyone and a very warm welcome to our school. We are so pleased to have parents, teachers, and students together in the same room today. Days like this are special. They give us a chance to step back from the routine of daily school life and celebrate what we have been building together over the past year. Our students have worked hard. Our teachers have given generously of their time and creativity. And our families have supported both in countless ways, many of which go unseen but none of which go unnoticed. Today is a chance to celebrate all of that together. We have a wonderful programme planned for the afternoon. There will be performances, presentations, and plenty of time to talk with one another afterwards. We hope you enjoy every moment of it. Thank you for being here. Your presence today tells our students that what they do matters. And it does. It truly does.' },
      { id:'ce5', title:'Farewell to a Retiring Colleague', level:'medium',
        text:'There are people in any workplace who are so consistently present, so reliably themselves, that you stop noticing them the way you stop noticing a wall until the day it is gone and the room feels strangely open and cold. Today we say goodbye to one of those people. Over more than two decades in this organization she has quietly shaped almost every team she has been part of. Not through grand gestures or formal authority, but through the patient daily work of being someone that others could count on. She remembered birthdays. She stayed late when deadlines pressed. She asked how you were and actually waited for the answer. These things sound small described one by one. Accumulated over twenty years they are anything but. We will miss her presence in ways that will surprise us long after today. We wish her every joy in the chapter ahead, and we thank her sincerely and inadequately for everything she gave to this place.' },
      { id:'ce6', title:'A Commencement Address', level:'hard',
        text:'I will not tell you that these are the best years of your lives, because I do not believe that is true, and I suspect you do not entirely believe it either. The best years of anyone\'s life are not a fixed destination that you have already passed or are rushing toward. They are built, incrementally and imperfectly, through the choices you make about how to spend your time, whom to love, what to pursue, and what to refuse. What I will tell you is this: you are leaving this institution better equipped than you know. You have practiced over these years the difficult art of sustained attention. You have learned that hard problems require patience, that good work demands revision, and that the most important things are rarely obvious at first glance. These are not academic skills. They are the skills of a life well-examined. The world you are entering is uncertain in ways that will sometimes frighten you. That is not a flaw in the design. Uncertainty is where all meaningful decisions live. Go toward it with the seriousness and curiosity you have cultivated here.' }
    ]
  },
  {
    id:'motivational', name:'ğŸ”¥ Motivational',
    passages:[
      { id:'mo1', title:'Keep Going', level:'easy',
        text:'There will be days when everything feels too hard and you wonder why you are even trying. On those days remember this: progress is almost never visible while it is happening. The seed does not feel itself growing. The river does not notice how slowly it is wearing down the rock. But growth is happening and the rock is being worn away, whether you can see it or not. Every effort you make, even the ones that feel pointless, is adding to something. Every time you choose to try again after failing you are becoming someone slightly different from the person who first started. The distance between where you began and where you will end up is not crossed in a single leap. It is crossed one small step at a time, on ordinary days, when no one is watching and it would be easier to stop. Do not stop. Keep going.' },
      { id:'mo2', title:'The Power of Persistence', level:'medium',
        text:'If you study the lives of people who have achieved something genuinely difficult, a pattern emerges that is both encouraging and inconvenient. Almost without exception the path to their success was not straight, not fast, and not obvious to anyone watching from the outside. It was paved with rejection, misunderstanding, long periods of invisibility, and the slow unglamorous accumulation of skill. The novelist who wrote three unpublished books before the fourth became a classic. The scientist whose hypothesis was dismissed for fifteen years before the evidence finally aligned. The athlete who did not make the team the first three times she tried out. What distinguished these people was not extraordinary talent or fortunate circumstance. It was the decision made repeatedly in private to continue. Persistence is not a fixed personality trait. It is a practice. And like all practices it is strengthened by repetition and weakened by disuse. The most important time to persist is the moment it feels most pointless. That is usually the moment just before something changes.' },
      { id:'mo3', title:'Ordinary People, Extraordinary Courage', level:'hard',
        text:'We tend to think of courage as something that belongs to a particular kind of person, a category of human being defined by physical daring, natural confidence, or a constitution somehow immune to doubt and fear. History, examined honestly, tells a different story. The most consequential acts of courage in any era have been performed by people who were by every ordinary measure ordinary. They were afraid. They doubted themselves. They could clearly imagine the cost of what they were about to do and chose to do it anyway, not because they felt certain of success but because the alternative, staying silent, staying still, staying safe, was something they found they could not live with. Courage is not the property of exceptional people. It is the response of ordinary people to extraordinary circumstances, and it is available to all of us. The question each of us must answer for ourselves is what we are willing to stand for when standing for it is genuinely difficult. That question has no comfortable answer, only the one that you can look back on without shame.' },
      { id:'mo4', title:'You Are Enough', level:'easy',
        text:'Sometimes the loudest voice telling you that you are not ready, not good enough, or not worthy of what you want is the one inside your own head. That voice is very persuasive and it is also very often wrong. You do not need to be perfect before you begin. You do not need to have everything figured out before you take the first step. You are allowed to start where you are, with what you have, right now. The people you admire most were once exactly where you are. They were uncertain. They made mistakes. They wondered whether they were good enough. The only difference between them and someone who never tries is that they chose to move forward anyway. You are more capable than you give yourself credit for. Your past does not determine your future. Today is a new chance to try, to learn, and to grow. You are enough, right now, to begin.' },
      { id:'mo5', title:'Turning Obstacles into Opportunities', level:'medium',
        text:'The ancient Stoics had a saying that has lost none of its relevance across two thousand years: the obstacle is the way. By this they meant that the thing standing between you and what you want is not an interruption of your path but the path itself. Resistance, difficulty, and failure are not signs that you are doing something wrong. They are signs that you are doing something real. Easy things require nothing of you and give back very little. It is the difficult things, the ones that push back and refuse to yield without effort, that build the qualities on which everything else depends. This reframing is not merely a motivational trick. It is a fundamental shift in how you relate to adversity. When you stop experiencing obstacles as evidence of your limitations and start experiencing them as raw material for growth something changes in how you engage with your own life. You become more curious, more resilient, and ultimately more effective. Every difficult thing you face is offering you something. The question is whether you are willing to receive it.' },
      { id:'mo6', title:'The Discipline of Daily Growth', level:'hard',
        text:'There is a seductive myth that transformation happens in moments of sudden insight or dramatic decision, that people change through the kind of pivotal event that can be narrated cleanly with a before and an after. This myth is appealing precisely because it is so much easier to imagine than the truth, which is that lasting change is almost always the product of small actions taken repeatedly, often tediously, over a long period of time without visible reward. The compound effect of daily discipline is genuinely extraordinary, but it is invisible in the short term, which is exactly when most people give up. One percent better each day produces results that are counterintuitive in their magnitude. The person who reads for thirty minutes each morning for ten years does not merely know more than the person who did not. They think differently, connect ideas differently, and bring a depth of reference to every conversation and decision that cannot be acquired any other way. Commit to daily growth not because of what you will achieve in a week or a month, but because of who you will have become in a decade.' }
    ]
  },
  {
    id:'sympathetic', name:'ğŸ’œ Sympathetic',
    passages:[
      { id:'sy1', title:'A Message of Comfort', level:'easy',
        text:'I know that right now words feel like very small things in the face of what you are carrying. I am not going to pretend that anything I say can make this easier. What I want you to know is simply this: you do not have to go through it alone. Grief and pain can make us feel invisible, as though no one around us could possibly understand what is happening inside us. But you are not invisible to me. I see you. I see how hard you are trying. I see the weight you are carrying and the grace with which you are carrying it, even on the days when it does not feel like grace at all. There is no right way to feel right now. Whatever you are feeling is allowed. Take as much time as you need. Reach out when you are ready and rest when you are not. I am here, I am not going anywhere, and you matter more than you know.' },
      { id:'sy2', title:'Walking Through Grief', level:'medium',
        text:'Grief does not move in a straight line and it does not keep to any schedule. It circles back. It ambushes you in ordinary moments, in the middle of a supermarket aisle or at the beginning of a song. It asks nothing of you except that you keep living, which on certain days is the hardest thing in the world. There is an enormous amount of unhelpful advice given to people who are grieving, most of it well-intentioned and almost all of it focused on the destination rather than the journey. The truth is that grief is not a problem to be solved or a wound to be healed as quickly as possible. It is the natural consequence of love, and it deserves to be moved through with patience and without judgment. The measure of grief is not weakness. It is the measure of what was lost and what was loved. You are not broken. You are bereaved. Those are not the same thing, and the difference matters more than most people are ever told.' },
      { id:'sy3', title:'The Gift of Presence', level:'hard',
        text:'When someone we care about is suffering, our first instinct is almost always to do something, to fix, to advise, to reassure, to find the right words that will, if not resolve the pain, at least demonstrate that we have taken it seriously. This instinct comes from a good place and it is also, in the deepest sense, beside the point. What suffering people most frequently say they needed and rarely received was not a solution but a witness. Someone who could sit with them in their difficulty without trying to redirect it, resolve it, or frame it more optimistically. This kind of presence is far more demanding than it sounds. It requires us to resist our own discomfort with pain, our own need to feel useful, and our own urge to restore equilibrium to a situation that is not yet ready to be restored. To be genuinely present with someone who is suffering is to accept their experience on its own terms, without rushing toward the silver lining. It is among the most difficult things one human being can offer another, and it is among the most healing.' },
      { id:'sy4', title:'You Are Not Alone', level:'easy',
        text:'Sometimes the hardest part of a difficult time is the feeling that no one else could possibly understand what you are going through. Pain can be very isolating. It can make the world feel very far away and make the people in it seem very small or very distant. I want you to know that however alone you feel right now you are not. There are people in your life who care about you deeply, even when life gets in the way of showing it as often as they should. And there are people all around the world who have felt exactly what you are feeling and who have found eventually a way through. You will too. You do not have to have everything sorted out. You do not have to be strong all the time. It is okay to accept help. It is okay to say you are struggling. It is okay to not be okay for a while. None of that means you are weak. It means you are human.' },
      { id:'sy5', title:'On Healing and Time', level:'medium',
        text:'People often say that time heals everything, and while I understand why that phrase has endured I am not sure it tells the whole truth. Time alone does not heal very much. What time offers is distance, and what we do with that distance matters enormously. Healing requires more than the passive passage of days. It asks us to make space for what we are feeling, to resist the temptation to bury it under busyness or optimism, and to allow ourselves to move through the full range of what we experience rather than choosing only the parts that are easiest to show. Healing also asks us to accept help when it is offered and to reach for connection when we feel the pull of isolation. These are not signs of weakness. They are the practical tools of recovery. Grief and loss do not follow a timetable and they do not respond to willpower. They ask for gentleness, patience, and the willingness to be honest with yourself about where you are, even when where you are is very far from where you want to be.' },
      { id:'sy6', title:'The Courage to Ask for Help', level:'hard',
        text:'We live in a culture that celebrates self-sufficiency and is uneasy with dependence. From an early age most of us absorb the message that asking for help is a last resort, a reluctant admission that our own resources have been exhausted. This message is not only unkind but demonstrably false. The most resilient people, in research and in life, are not those who need the least from others. They are those who have built the deepest and most reciprocal networks of support, who are comfortable giving help and equally comfortable receiving it. Asking for help when you are struggling is not a failure of character. It is an act of self-knowledge and courage. It requires you to acknowledge vulnerability in a world that often punishes vulnerability, to trust another person with something true about your inner life, and to accept that you are not required to manage everything alone. The people who love you do not want to be protected from your difficulties. They want the chance to be present in them with you. Letting them in is not a burden to them. It is, very often, a gift.' }
    ]
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentThemeId  = THEMES[0].id;
let currentPassage  = THEMES[0].passages[0];
let themePages      = {};   // { themeId: pageIndex } â€” which set of 3 passages is shown
let recognition     = null;
let isRecording     = false;
let finalText       = '';
let startTime       = null;
let recordInterval  = null;
let recordSeconds   = 0;

// MediaRecorder
let micStream       = null;
let mediaRecorder   = null;
let audioChunks     = [];
let recordingBlob   = null;
let replayBlobUrl   = null;

// iOS proactive restart (avoid forced ~60s timeout)
let proactiveRestartTimer = null;

// Sentence-by-sentence mode (mobile â€” avoids iOS session timeout)
let sentenceMode  = false;
let sentences     = [];
let sentenceIdx   = 0;
let sentenceTexts = [];

// Practice modal
let practiceWordStr    = '';
let practiceStream     = null;
let practiceRecorder   = null;
let practiceIsRecording= false;
let practiceTimerInt   = null;
let practiceSecsLeft   = 5;
let practiceBlobUrl    = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM REFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const themeTabsEl   = document.getElementById('themeTabs');
const passageGrid   = document.getElementById('passageGrid');
const passageTitle  = document.getElementById('passageTitle');
const passageTextEl = document.getElementById('passageText');
const recordBtn     = document.getElementById('recordBtn');
const statusText    = document.getElementById('statusText');
const resetBtn      = document.getElementById('resetBtn');
const transcriptEl  = document.getElementById('transcriptText');
const resultsCard   = document.getElementById('resultsCard');
const replayRow     = document.getElementById('replayRow');
const replayAudio   = document.getElementById('replayAudio');
const gradeBadge    = document.getElementById('gradeBadge');
const scoreAccuracy = document.getElementById('scoreAccuracy');
const scoreWords    = document.getElementById('scoreWords');
const scoreWPM      = document.getElementById('scoreWPM');
const accuracyBar   = document.getElementById('accuracyBar');
const wordAnalysis  = document.getElementById('wordAnalysis');
const tipBox        = document.getElementById('tipBox');
const browserNotice = document.getElementById('browserNotice');
const practiceModal = document.getElementById('practiceModal');
const practiceWordDisplay = document.getElementById('practiceWordDisplay');
const practiceRecBtn      = document.getElementById('practiceRecBtn');
const practiceRecInd      = document.getElementById('practiceRecInd');
const practiceTimerTxt    = document.getElementById('practiceTimerTxt');
const practicePlayer      = document.getElementById('practicePlayer');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BROWSER CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
const hasMediaRecorder     = !!(window.MediaRecorder && navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
const hasTTS               = !!window.speechSynthesis;
const isIOS                = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isMobile             = isIOS || /Android/i.test(navigator.userAgent);

// On mobile, file:// blocks speech recognition â€” must use HTTPS. Desktop Chrome/Edge is fine.
if (location.protocol === 'file:' && isMobile) {
  browserNotice.style.display = 'block';
  browserNotice.innerHTML = 'âš ï¸ On mobile, this app must be opened from a web address. '
    + 'Open it at <a href="https://daiboyi110.github.io/readalong/" style="color:#92400e;font-weight:700;">https://daiboyi110.github.io/readalong/</a>';
  recordBtn.disabled = true;
} else if (!SpeechRecognitionAPI) {
  browserNotice.style.display = 'block';
  browserNotice.innerHTML = isIOS
    ? 'âš ï¸ On iPhone/iPad, use <strong>Safari</strong> (iOS 16+). Speech recognition is not available in Chrome or Firefox on iOS.'
    : 'âŒ Speech recognition is not supported. Please open this page in <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong>.';
  recordBtn.disabled = true;
} else if (isMobile) {
  browserNotice.style.display = 'block';
  browserNotice.innerHTML = isIOS
    ? 'ğŸ“± iPhone/iPad (Safari only): Tap <strong>Allow</strong> when asked. If you see the â†º button, pause for 1 second then keep reading.'
    : 'ğŸ“± Android: When asked, tap <strong>Allow</strong> for microphone access. Chrome works best.';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME & PASSAGE UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderThemeTabs() {
  themeTabsEl.innerHTML = THEMES.map(t => `
    <button class="theme-tab ${t.id === currentThemeId ? 'active' : ''}"
            onclick="switchTheme('${t.id}')">${t.name}</button>
  `).join('');
}

function switchTheme(id) {
  if (isRecording) stopRecording();
  currentThemeId = id;
  const theme = THEMES.find(t => t.id === id);
  const page  = themePages[id] || 0;
  currentPassage = theme.passages[page * 3] || theme.passages[0];
  renderThemeTabs();
  renderPassageGrid();
  renderPassage();
  resetResults();
}

function renderPassageGrid() {
  const theme      = THEMES.find(t => t.id === currentThemeId);
  const page       = themePages[currentThemeId] || 0;
  const perPage    = 3;
  const totalPages = Math.ceil(theme.passages.length / perPage);
  const pagePsg    = theme.passages.slice(page * perPage, (page + 1) * perPage);

  passageGrid.innerHTML = pagePsg.map(p => `
    <div class="pcard ${p.id === currentPassage.id ? 'active' : ''}" onclick="selectPassage('${p.id}')">
      <div class="pcard-title">${p.title}</div>
      <span class="badge ${p.level}">${p.level}</span>
    </div>
  `).join('');

  const btnEl = document.getElementById('updatePassagesBtn');
  if (totalPages > 1) {
    btnEl.innerHTML = `<button class="ghost-btn" onclick="updatePassages('${currentThemeId}')">â†» New Passages &nbsp;<span style="font-size:.75rem;opacity:.7">Set ${page + 1} / ${totalPages}</span></button>`;
  } else {
    btnEl.innerHTML = '';
  }
}

function updatePassages(themeId) {
  if (isRecording) stopRecording();
  const theme      = THEMES.find(t => t.id === themeId);
  const page       = themePages[themeId] || 0;
  const perPage    = 3;
  const totalPages = Math.ceil(theme.passages.length / perPage);
  const nextPage   = (page + 1) % totalPages;
  themePages[themeId] = nextPage;
  currentPassage = theme.passages[nextPage * perPage];
  renderPassageGrid();
  renderPassage();
  resetResults();
  finalText = '';
  transcriptEl.innerHTML = '<span class="placeholder">Your spoken words will appear here in real timeâ€¦</span>';
}

function selectPassage(id) {
  if (isRecording) stopRecording();
  const theme = THEMES.find(t => t.id === currentThemeId);
  currentPassage = theme.passages.find(p => p.id === id);
  renderPassageGrid();
  renderPassage();
  resetResults();
  // reset transcript
  finalText = '';
  transcriptEl.innerHTML = '<span class="placeholder">Your spoken words will appear here in real timeâ€¦</span>';
}

function renderPassage(matchedSet) {
  passageTitle.textContent = currentPassage.title;
  const words = currentPassage.text.split(/\s+/).filter(Boolean);
  if (matchedSet) {
    passageTextEl.innerHTML = words.map((w, i) =>
      `<span class="w ${matchedSet.has(i) ? 'correct' : 'incorrect'}">${w}</span>`
    ).join(' ');
  } else {
    passageTextEl.textContent = currentPassage.text;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPEECH RECOGNITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRecognition() {
  const r = new SpeechRecognitionAPI();
  r.continuous      = true;
  r.interimResults  = true;
  r.lang            = 'en-US';
  r.maxAlternatives = 1;

  let didStart     = false; // tracks whether onstart ever fired for this instance
  let interimBuffer = '';   // latest interim text â€” rescued into finalText on session end

  r.onstart = () => {
    didStart = true;
    recordBtn.classList.remove('pausing');
    recordBtn.classList.add('recording');
    recordBtn.innerHTML = 'â¹';
    statusText.classList.add('live');
    startRecordTimer();

    // iOS: proactively restart at 45s â€” safely before iOS's hard ~60s session limit.
    // This way WE control the restart timing and avoid losing the last chunk of speech.
    if (isIOS) {
      clearTimeout(proactiveRestartTimer);
      proactiveRestartTimer = setTimeout(() => {
        if (isRecording && recognition) recognition.stop();
      }, 45000);
    }
  };

  r.onresult = (e) => {
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) { finalText += t + ' '; interimBuffer = ''; }
      else interim = t;
    }
    interimBuffer = interim; // keep latest interim so onend can rescue it
    transcriptEl.innerHTML =
      (finalText  ? `<span>${finalText}</span>` : '') +
      (interim    ? `<span class="interim">${interim}</span>` : '');
    transcriptEl.scrollTop = transcriptEl.scrollHeight;
  };

  r.onerror = (e) => {
    if (e.error === 'no-speech') return; // silence timeout â€” harmless, onend will restart
    if (e.error === 'network')   return; // transient on mobile â€” onend will restart
    if (e.error === 'audio-capture') {
      statusText.textContent = 'ğŸ™ï¸ Microphone not found. Check your device settings.';
      isRecording = false; resetRecordBtn(); return;
    }
    if (e.error === 'not-allowed') {
      statusText.textContent = isMobile
        ? 'ğŸš« Microphone blocked. Go to your browser Settings â†’ Site permissions â†’ Microphone and allow this page.'
        : 'ğŸš« Microphone access denied. Click the ğŸ”’ icon in the address bar to allow it.';
      isRecording = false;
      if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      resetRecordBtn();
    }
  };

  r.onend = () => {
    clearTimeout(proactiveRestartTimer);
    if (!isRecording) return;

    // Silent failure: onend fired but onstart NEVER fired â†’ mic was blocked
    if (!didStart) {
      isRecording = false;
      resetRecordBtn();
      stopRecordTimer();
      statusText.textContent = isIOS
        ? 'ğŸš« Microphone blocked. On your iPhone: Settings â†’ Safari â†’ Microphone â†’ set this site to Allow. Then reload and try again.'
        : 'ğŸš« Microphone access was blocked. Click the ğŸ”’ icon in your address bar, set Microphone to Allow, then try again.';
      return;
    }

    // Rescue any interim text that iOS cut off before it could be finalized
    if (interimBuffer.trim()) {
      finalText    += interimBuffer.trim() + ' ';
      interimBuffer = '';
    }

    // Show "pausing" spinner so user knows to briefly pause (~0.5s) while mic resets
    if (isIOS) {
      recordBtn.classList.remove('recording');
      recordBtn.classList.add('pausing');
      recordBtn.innerHTML = 'â†º';
      statusText.textContent = 'â†º Mic refreshing â€” keep reading in a momentâ€¦';
    }

    const delay = isIOS ? 600 : 250;
    setTimeout(() => {
      if (!isRecording) return;
      recognition = buildRecognition(); // fresh instance required on iOS
      try { recognition.start(); }
      catch(_) {}
    }, delay);
  };

  return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEDIA RECORDER (full-session audio capture)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getMimeType() {
  for (const t of ['audio/webm;codecs=opus','audio/webm','audio/ogg','audio/mp4']) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
  }
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SENTENCE-BY-SENTENCE MODE (mobile)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseSentences(text) {
  // Split on sentence-ending punctuation, keeping the punctuation attached
  const parts = text.match(/[^.!?]*[.!?]+/g) || [text];
  return parts.map(s => s.trim()).filter(s => s.length > 0);
}

function enterSentenceMode() {
  sentences     = parseSentences(currentPassage.text);
  sentenceIdx   = 0;
  sentenceTexts = new Array(sentences.length).fill('');
  sentenceMode  = true;
  renderSentenceDisplay(0);
  document.getElementById('sentenceNav').classList.add('show');
  recordSentence(0);
}

function renderSentenceDisplay(currentIdx) {
  passageTitle.textContent = currentPassage.title;
  passageTextEl.innerHTML = sentences.map((s, i) => {
    let cls = 's-block ';
    if      (i < currentIdx)  cls += 's-done';
    else if (i === currentIdx) cls += 's-current';
    else                       cls += 's-next';
    return `<span class="${cls}">${s}</span>`;
  }).join('');
  const progEl = document.getElementById('sentenceProgress');
  if (progEl) progEl.textContent = `Sentence ${currentIdx + 1} of ${sentences.length}`;
}

function recordSentence(idx) {
  if (!isRecording) return;
  if (idx >= sentences.length) { finishSentences(); return; }
  sentenceIdx = idx;
  renderSentenceDisplay(idx);

  const r = new SpeechRecognitionAPI();
  r.continuous      = false;  // stop after natural pause â†’ perfect for one sentence
  r.interimResults  = true;
  r.lang            = 'en-US';
  r.maxAlternatives = 1;
  recognition = r;

  let final    = '';
  let interim  = '';
  let didStart = false;

  r.onstart = () => {
    didStart = true;
    recordBtn.classList.remove('pausing');
    recordBtn.classList.add('recording');
    recordBtn.innerHTML = 'â¹';
    statusText.classList.add('live');
    statusText.textContent = `ğŸ”´ Sentence ${idx + 1} of ${sentences.length} â€” read aloud`;
  };

  r.onresult = (e) => {
    interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) final += t + ' ';
      else interim = t;
    }
    transcriptEl.innerHTML =
      (final   ? `<span>${final}</span>` : '') +
      (interim ? `<span class="interim">${interim}</span>` : '');
  };

  r.onerror = (e) => {
    if (e.error === 'no-speech') return; // silence â†’ onend will advance
    if (e.error === 'network')   return;
    if (e.error === 'not-allowed') {
      isRecording = false;
      sentenceMode = false;
      document.getElementById('sentenceNav').classList.remove('show');
      resetRecordBtn();
      statusText.textContent = isIOS
        ? 'ğŸš« Microphone blocked. Settings â†’ Safari â†’ Microphone â†’ Allow this site.'
        : 'ğŸš« Microphone blocked. Allow it in your browser settings.';
    }
  };

  r.onend = () => {
    if (!isRecording) return;

    // Silent failure: mic was blocked
    if (!didStart) {
      isRecording  = false;
      sentenceMode = false;
      document.getElementById('sentenceNav').classList.remove('show');
      resetRecordBtn();
      stopRecordTimer();
      statusText.textContent = isIOS
        ? 'ğŸš« Microphone blocked. On your iPhone: Settings â†’ Safari â†’ Microphone â†’ Allow. Then reload.'
        : 'ğŸš« Microphone blocked. Click the ğŸ”’ icon in your address bar to allow it.';
      return;
    }

    // Save what was heard for this sentence
    sentenceTexts[idx] = final.trim();
    finalText = sentenceTexts.filter(Boolean).join(' ');

    const nextIdx = idx + 1;
    if (nextIdx >= sentences.length) {
      finishSentences();
      return;
    }

    // Brief pause, then start next sentence
    recordBtn.classList.remove('recording');
    recordBtn.classList.add('pausing');
    recordBtn.innerHTML = 'â†º';
    statusText.textContent = `â†º Sentence ${idx + 1} done â€” pause, then read sentence ${nextIdx + 1}â€¦`;
    const progEl = document.getElementById('sentenceProgress');
    if (progEl) progEl.textContent = `Sentence ${nextIdx + 1} of ${sentences.length}`;

    setTimeout(() => {
      if (!isRecording) return;
      recordSentence(nextIdx);
    }, isIOS ? 700 : 350);
  };

  try { r.start(); } catch(err) { console.warn('recordSentence start error:', err); }
}

function advanceSentenceManually() {
  // Stop current recognition â†’ onend fires â†’ saves text â†’ advances to next sentence
  if (recognition) {
    try { recognition.stop(); } catch(_) {}
  }
}

function finishSentences() {
  sentenceMode = false;
  isRecording  = false;
  clearTimeout(proactiveRestartTimer);
  stopRecordTimer();
  document.getElementById('sentenceNav').classList.remove('show');
  resetRecordBtn();
  statusText.textContent = 'Done! Your results are below â†“';

  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    setTimeout(() => {
      if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    }, 400);
  } else {
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
  }

  setTimeout(() => {
    const full = finalText.trim();
    if (full) showResults(full);
    else statusText.textContent = 'No speech detected â€” please try again.';
  }, 800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECORDING CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startRecording() {
  if (!SpeechRecognitionAPI) return;

  finalText     = '';
  recordingBlob = null;
  transcriptEl.innerHTML = '<span class="placeholder">Startingâ€¦</span>';
  statusText.textContent  = isIOS ? 'Tap Allow when your browser asks for mic accessâ€¦'
                                  : 'Requesting microphone accessâ€¦';
  resetResults();

  // Skip getUserMedia on iOS â€” prevents double permission dialog on every restart
  if (hasMediaRecorder && !isIOS) {
    try {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    } catch(err) {
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        statusText.textContent = 'ğŸš« Microphone access denied. Click the ğŸ”’ icon in your address bar to allow it.';
        transcriptEl.innerHTML = '<span class="placeholder">â€¦</span>';
        return;
      }
      micStream = null;
    }
  }

  if (micStream) {
    try {
      const mime  = getMimeType();
      audioChunks = [];
      mediaRecorder = mime
        ? new MediaRecorder(micStream, { mimeType: mime })
        : new MediaRecorder(micStream);
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        recordingBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
      };
      mediaRecorder.start(200);
    } catch(err) {
      console.warn('MediaRecorder setup failed:', err);
    }
  }

  recognition = buildRecognition();
  try {
    recognition.start();
    isRecording = true;
    startTime   = Date.now();
    transcriptEl.innerHTML = '<span class="placeholder">Listeningâ€¦ read aloud now</span>';
    if (isIOS) statusText.textContent = 'ğŸ“± Allow mic access if asked, then start readingâ€¦';
  } catch(err) {
    statusText.textContent = `Could not start: ${err.message}`;
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  }
}

function stopRecording() {
  isRecording = false;
  clearTimeout(proactiveRestartTimer);
  stopRecordTimer();

  if (sentenceMode) {
    sentenceMode = false;
    document.getElementById('sentenceNav').classList.remove('show');
  }

  if (recognition) { try { recognition.stop(); } catch(_) {} recognition = null; }

  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    setTimeout(() => {
      if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    }, 400);
  } else {
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
  }

  resetRecordBtn();
  statusText.textContent = 'Done! Your results are below â†“';

  setTimeout(() => {
    const full = finalText.trim();
    if (full) showResults(full);
    else       statusText.textContent = 'No speech detected â€” please try again.';
  }, 800);
}

function resetRecordBtn() {
  recordBtn.classList.remove('recording');
  recordBtn.innerHTML = 'ğŸ¤';
  statusText.classList.remove('live');
}

recordBtn.addEventListener('click', () => { isRecording ? stopRecording() : startRecording(); });
resetBtn.addEventListener('click',  () => { if (isRecording) stopRecording(); resetAll(); });

function resetAll() {
  isRecording   = false;
  sentenceMode  = false;
  sentences     = [];
  sentenceIdx   = 0;
  sentenceTexts = [];
  clearTimeout(proactiveRestartTimer);
  finalText   = '';
  startTime   = null;
  recordingBlob = null;
  if (replayBlobUrl) { URL.revokeObjectURL(replayBlobUrl); replayBlobUrl = null; }
  stopRecordTimer();
  resetRecordBtn();
  document.getElementById('sentenceNav').classList.remove('show');
  statusText.textContent = 'Click the microphone to start reading aloud';
  transcriptEl.innerHTML = '<span class="placeholder">Your spoken words will appear here in real timeâ€¦</span>';
  resetResults();
  renderPassage();
}

function resetResults() {
  resultsCard.classList.remove('visible');
  replayRow.style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECORD TIMER (clock display while recording)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startRecordTimer() {
  recordSeconds = 0;
  recordInterval = setInterval(() => {
    recordSeconds++;
    const m = String(Math.floor(recordSeconds / 60)).padStart(1,'0');
    const s = String(recordSeconds % 60).padStart(2,'0');
    statusText.textContent = `ğŸ”´ Recording  ${m}:${s}  â€” read the passage aloud`;
  }, 1000);
}

function stopRecordTimer() {
  if (recordInterval) { clearInterval(recordInterval); recordInterval = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEXT ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function normalizeWord(w) { return w.toLowerCase().replace(/[^a-z0-9']/g,''); }
function tokenize(text)   { return text.split(/\s+/).filter(Boolean).map(normalizeWord).filter(w => w.length > 0); }

function wordLCS(orig, trans) {
  const m = orig.length, n = trans.length;
  const dp = new Uint16Array((m+1)*(n+1));
  const I  = (i,j) => i*(n+1)+j;
  for (let i=1;i<=m;i++)
    for (let j=1;j<=n;j++)
      dp[I(i,j)] = orig[i-1]===trans[j-1] ? dp[I(i-1,j-1)]+1 : Math.max(dp[I(i-1,j)],dp[I(i,j-1)]);
  const matched = new Set();
  let i=m, j=n;
  while (i>0 && j>0) {
    if (orig[i-1]===trans[j-1]) { matched.add(i-1); i--; j--; }
    else if (dp[I(i-1,j)] >= dp[I(i,j-1)]) i--;
    else j--;
  }
  return { matched, lcsLen: dp[I(m,n)] };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOW RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResults(transcript) {
  const displayWords = currentPassage.text.split(/\s+/).filter(Boolean);
  const origNorm     = displayWords.map(normalizeWord);
  const transNorm    = tokenize(transcript);

  const { matched, lcsLen } = wordLCS(origNorm, transNorm);

  const total   = origNorm.length;
  const correct = lcsLen;
  const pct     = Math.round((correct / total) * 100);

  // WPM
  let wpm = 'â€”';
  if (startTime) {
    const mins = (Date.now() - startTime) / 60000;
    if (mins > 0) wpm = Math.round(transNorm.length / mins);
  }

  // Grade
  const [grade, gCls] =
    pct >= 95 ? ['A+','grade-Ap'] :
    pct >= 90 ? ['A', 'grade-A']  :
    pct >= 80 ? ['B', 'grade-B']  :
    pct >= 70 ? ['C', 'grade-C']  :
    pct >= 60 ? ['D', 'grade-D']  : ['F','grade-F'];

  gradeBadge.textContent = grade;
  gradeBadge.className   = `grade-badge ${gCls}`;
  scoreAccuracy.textContent = `${pct}%`;
  scoreWords.textContent    = `${correct}/${total}`;
  scoreWPM.textContent      = wpm;

  accuracyBar.style.width =
    pct >= 80 ? `${pct}%; background:linear-gradient(90deg,#10b981,#059669)` :
    `${pct}%`;
  accuracyBar.style.background =
    pct >= 80 ? 'linear-gradient(90deg,#10b981,#059669)' :
    pct >= 60 ? 'linear-gradient(90deg,#f59e0b,#d97706)' :
                'linear-gradient(90deg,#f87171,#dc2626)';
  accuracyBar.style.width = `${pct}%`;

  // Word chips
  wordAnalysis.innerHTML = '';
  displayWords.forEach((w, i) => {
    const isMatch = matched.has(i);
    const wrap = document.createElement('span');
    wrap.className = `wr ${isMatch ? 'match' : 'miss'}`;

    const txt = document.createElement('span');
    txt.textContent = w;
    wrap.appendChild(txt);

    if (!isMatch) {
      const cleanWord = normalizeWord(w);

      const ttsBtn = document.createElement('button');
      ttsBtn.className = 'wr-icon';
      ttsBtn.title = 'Hear correct pronunciation';
      ttsBtn.textContent = 'ğŸ”Š';
      ttsBtn.onclick = (e) => { e.stopPropagation(); ttsSpeak(cleanWord, 1); };

      const practiceBtn = document.createElement('button');
      practiceBtn.className = 'wr-icon';
      practiceBtn.title = 'Practice this word';
      practiceBtn.textContent = 'ğŸ¤';
      practiceBtn.onclick = (e) => { e.stopPropagation(); openModal(cleanWord); };

      wrap.appendChild(ttsBtn);
      wrap.appendChild(practiceBtn);
    }
    wordAnalysis.appendChild(wrap);
  });

  // Highlight passage
  renderPassage(matched);

  // Tip
  tipBox.textContent =
    pct >= 95 ? 'ğŸŒŸ Outstanding! You read with near-perfect accuracy. Excellent work!' :
    pct >= 85 ? 'ğŸ‘ Great job! A little more practice on the highlighted words and you\'ll nail it.' :
    pct >= 70 ? 'ğŸ“– Good effort! Focus on the red words â€” click ğŸ”Š to hear them, then ğŸ¤ to practise.' :
                'ğŸ’ª Keep going! Try listening to each missed word and record your own attempt to compare.';

  // Replay audio
  if (recordingBlob) {
    if (replayBlobUrl) URL.revokeObjectURL(replayBlobUrl);
    replayBlobUrl = URL.createObjectURL(recordingBlob);
    replayAudio.src = replayBlobUrl;
    replayRow.style.display = 'flex';
  }

  resultsCard.classList.add('visible');
  setTimeout(() => resultsCard.scrollIntoView({ behavior:'smooth', block:'start' }), 80);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ttsSpeak(word, rate) {
  if (!hasTTS) return;
  window.speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(word);
  utt.lang  = 'en-US';
  utt.rate  = rate;
  utt.pitch = 1;
  window.speechSynthesis.speak(utt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRACTICE MODAL  (speech-recognition word check)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let wordCheckRec = null;

function openModal(word) {
  practiceWordStr = word;
  practiceWordDisplay.textContent = word;
  practiceRecBtn.innerHTML = 'ğŸ¤ Say it';
  practiceRecBtn.disabled = false;
  document.getElementById('practiceListening').classList.remove('show');
  const res = document.getElementById('wordResult');
  res.className = 'word-result';
  res.textContent = '';
  practiceIsRecording = false;
  if (wordCheckRec) { try { wordCheckRec.stop(); } catch(_){} wordCheckRec = null; }
  practiceModal.classList.add('open');
  setTimeout(() => ttsSpeak(word, 1), 300);
}

function closeModal() {
  if (wordCheckRec) { try { wordCheckRec.stop(); } catch(_){} wordCheckRec = null; }
  practiceIsRecording = false;
  practiceModal.classList.remove('open');
  window.speechSynthesis.cancel();
}

practiceModal.addEventListener('click', e => { if (e.target === practiceModal) closeModal(); });

function speakPracticeWord(rate) { ttsSpeak(practiceWordStr, rate); }

function startWordCheck() {
  if (!SpeechRecognitionAPI) { alert('Speech recognition not supported in this browser.'); return; }
  if (practiceIsRecording) return;
  practiceIsRecording = true;

  const listeningEl = document.getElementById('practiceListening');
  const resultEl    = document.getElementById('wordResult');
  resultEl.className = 'word-result';
  resultEl.textContent = '';
  listeningEl.classList.add('show');
  practiceRecBtn.disabled = true;

  wordCheckRec = new SpeechRecognitionAPI();
  wordCheckRec.continuous      = false;
  wordCheckRec.interimResults  = false;
  wordCheckRec.lang            = 'en-US';
  wordCheckRec.maxAlternatives = 3; // check top 3 alternatives

  wordCheckRec.onresult = (e) => {
    const target = normalizeWord(practiceWordStr);
    // Check all returned alternatives for a match
    let heard = '';
    let matched = false;
    for (let a = 0; a < e.results[0].length; a++) {
      const alt = normalizeWord(e.results[0][a].transcript.trim().split(/\s+/).pop()); // last word
      if (!heard) heard = normalizeWord(e.results[0][a].transcript.trim());
      if (alt === target) { matched = true; break; }
    }
    listeningEl.classList.remove('show');
    if (matched) {
      resultEl.className = 'word-result correct';
      resultEl.textContent = 'âœ“ Correct! Great pronunciation.';
    } else {
      resultEl.className = 'word-result wrong';
      resultEl.textContent = `âœ— Heard: "${heard}" â€” try again`;
    }
    practiceRecBtn.disabled = false;
    practiceRecBtn.innerHTML = 'ğŸ¤ Try again';
    practiceIsRecording = false;
    wordCheckRec = null;
  };

  wordCheckRec.onerror = (e) => {
    listeningEl.classList.remove('show');
    if (e.error !== 'no-speech') {
      resultEl.className = 'word-result wrong';
      resultEl.textContent = `Mic error: ${e.error}`;
    }
    practiceRecBtn.disabled = false;
    practiceRecBtn.innerHTML = 'ğŸ¤ Try again';
    practiceIsRecording = false;
    wordCheckRec = null;
  };

  wordCheckRec.onend = () => {
    listeningEl.classList.remove('show');
    practiceRecBtn.disabled = false;
    if (practiceIsRecording) {
      // no-speech: nothing was said
      resultEl.className = 'word-result wrong';
      resultEl.textContent = 'Nothing heard â€” please speak clearly and try again.';
      practiceRecBtn.innerHTML = 'ğŸ¤ Try again';
      practiceIsRecording = false;
    }
    wordCheckRec = null;
  };

  try { wordCheckRec.start(); } catch(err) {
    listeningEl.classList.remove('show');
    practiceRecBtn.disabled = false;
    practiceIsRecording = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderThemeTabs();
renderPassageGrid();
renderPassage();
</script>
</body>
</html>
